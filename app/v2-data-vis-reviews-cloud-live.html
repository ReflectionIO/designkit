<!doctype html>
<html lang="en" class="no-js" ng-app="reflectionApp">
<head>
	<meta charset="utf-8" />
	<title>Reflection Data Lab, App Reviews Analysis</title>
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<link rel="stylesheet" media="screen, projection" type="text/css" href="reflection-main-v2.css" />
<script src="https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js"></script>
<link rel="stylesheet" href="js/vendor/jquery.mCustomScrollbar.css" />
<script>
  WebFont.load({
    google: {
      families: ['Open Sans:400,600,700,400italic,600italic', 'Source Sans Pro:400,600,700', 'Lato:400,700,400italic']
    }
  });
</script> <script src="js/vendor/modernizr.2.8.3.custom.min.js"></script></head>
<body>
	<!--[if (lt IE 9)]>
      <div class="window-warning">
  			<p>Uh oh... Reflection doesn't work in this browser. &nbsp; &nbsp;<a href="http://outdatedbrowser.com/en" target="_blank">Download a compatible browser</a></p>
  		</div>
  <![endif]-->
  <header id="js-component-import--global-header" class="global-header"></header>
  
	<div id="js-component-import--panel-left" class="panel-left js-panel-left js-custom-scrollbar" data-mcs-theme="minimal-dark"></div>

	<div class="l-page-container">
		<div id="main" class="l-main" role="main">
			<div class="page-lab-base grid-container page-data-vis-reviews-cloud theme-dark is-initial-state overflow-visible">

				<img src="images/data-lab-article-making-top-mock-data.png" alt="Sharing image of the chart" style="position: fixed; left: -999rem;" />

				<div class="grid__row">
					<div class="grid__row--heading-row__right">
	 					<div class="sharing-container">
	 						<div class="addthis_sharing_toolbox"></div>
	 					</div>
					</div>
				</div>
				
				<div class="page-data-vis-reviews-cloud__center-column overflow-visible">
					<div class="page-data-vis-reviews-cloud__main-content-container overflow-visible">
						<div class="filters-row js-reviews-cloud-filters-row overflow-visible">
							<div class="overflow-visible">
								<div class="page-data-vis-reviews-cloud__app-column__app-icon-container">
									<img 
										src="images/data-vis-reviews-cloud-app-icon-placeholder.jpg"
										alt="App Name"
										class="js-app-icon" />
								</div>
								<div style="display: inline-block;" class="overflow-visible">
									<div class="secondary-filter secondary-filter--medium form-field--search">
										<input type="text" placeholder="Find an App" name="appId" id="appId" class="js-app-search-input" />
										<label for="findapp" class="ref-icon-after--search"><span>Search</span></label>
										<a href="#" class="clear-search ref-icon-after--close js-clear-search">Clear</a>
										<ul class="form-field--select__dropdown js-search-results-drop-down" style="min-width: 250px; display: none; left: -2px; top: 42px;">
											<div class="app-search-loading-indicator js-app-search-loading-indicator" style="display: none;">
												<span>Searching...</span>
												<img src="images/loadingSpinner.gif" alt="Loading" class="search-loading-indicator" /></div>
										</ul>
									</div>
									<h3 class="page-data-vis-reviews-cloud__developer-name">
										By <span class="js-developer-name">Developer Name</span>
									</h3>
									<span>View App Page</span>
								</div>
								
								<div class="secondary-filter secondary-filter--medium form-field--select js-secondary-filter js-dropdown-country">
									<select class="js-select-box">
										<option value="GB" selected="selected" class="icon-flag-sm icon-flag--GB">United Kingdom</option>
										<option value="US" class="icon-flag-sm icon-flag--US">USA</option>
										<option value="AU" class="icon-flag-sm icon-flag--AU">Australia</option>
										<option value="BR" class="icon-flag-sm icon-flag--BR">Brazil</option>
										<option value="CA" class="icon-flag-sm icon-flag--CA">Canada</option>
										<option value="DK" class="icon-flag-sm icon-flag--DK">Denmark</option>
										<option value="FR" class="icon-flag-sm icon-flag--FR">France</option>
										<option value="DE" class="icon-flag-sm icon-flag--DE">Germany</option>
										<option value="ID" class="icon-flag-sm icon-flag--ID">Indonesia</option>
										<option value="IE" class="icon-flag-sm icon-flag--IE">Ireland</option>
										<option value="IT" class="icon-flag-sm icon-flag--IT">Italy</option>
										<option value="MY" class="icon-flag-sm icon-flag--MY">Malaysia</option>
										<option value="MX" class="icon-flag-sm icon-flag--MX">Mexico</option>
										<option value="NZ" class="icon-flag-sm icon-flag--NZ">New Zealand</option>
										<option value="NO" class="icon-flag-sm icon-flag--NO">Norway</option>
										<option value="PT" class="icon-flag-sm icon-flag--PT">Portugal</option>
										<option value="RU" class="icon-flag-sm icon-flag--RU">Russia</option>
										<option value="SA" class="icon-flag-sm icon-flag--SA">Saudi Arabia</option>
										<option value="SG" class="icon-flag-sm icon-flag--SG">Singapore</option>
										<option value="ES" class="icon-flag-sm icon-flag--ES">Spain</option>
										<option value="SE" class="icon-flag-sm icon-flag--SE">Sweden</option>
										<option value="TR" class="icon-flag-sm icon-flag--TR">Turkey</option>
										<option value="AE" class="icon-flag-sm icon-flag--AE">United Arab Emirates</option>
									</select>
								</div>
							</div>
														
						</div>
					</div>
				</div>
			</div>
				
			<section class="chart-container chart-container--split" style="background: #29292C; padding-bottom: 30px; z-index: 1;">
				<div class="chart" id="chart-reviews" style="overflow: visible;"></div>
			</section>
			
			<div class="page-lab-base grid-container page-data-vis-reviews-cloud theme-dark is-initial-state">
				<div class="page-data-vis-reviews-cloud__center-column">
					<div class="page-data-vis-reviews-cloud__main-content-container">
						<div>
							<aside class="page-data-vis-reviews-cloud__app-column">

								<div class="page-data-vis-reviews-cloud__reviews-widget">
									<h4>Times <span class="js-keyword-hover">'Keyword'</span> Appears in Recent Reviews</h4>
									<h5>Total <span class="selected-country-text js-selected-country-text"></span>: <span class="total-reviews-count js-all-stars">-</span></h5>
									<ul>
										<li>
											<span class="number-of-stars-label ref-icon-after--star">5</span>
											<span class="rating-number js-five-stars"></span>
											<div class="rating-percentage-container"><div class="rating-percentage"></div></div>
											<span class="rating-percentage-text js-five-stars-percent">%</span>
										</li>
										<li>
											<span class="number-of-stars-label ref-icon-after--star">4</span>
											<span class="rating-number js-four-stars"></span>
											<div class="rating-percentage-container"><div class="rating-percentage"></div></div>
											<span class="rating-percentage-text js-four-stars-percent">%</span>
										</li>
										<li>
											<span class="number-of-stars-label ref-icon-after--star">3</span>
											<span class="rating-number js-three-stars"></span>
											<div class="rating-percentage-container"><div class="rating-percentage"></div></div>
											<span class="rating-percentage-text js-three-stars-percent">%</span>
										</li>
										<li>
											<span class="number-of-stars-label ref-icon-after--star">2</span>
											<span class="rating-number js-two-stars"></span>
											<div class="rating-percentage-container"><div class="rating-percentage"></div></div>
											<span class="rating-percentage-text js-two-stars-percent">%</span>
										</li>
										<li>
											<span class="number-of-stars-label ref-icon-after--star">1</span>
											<span class="rating-number js-one-stars"></span>
											<div class="rating-percentage-container"><div class="rating-percentage"></div></div>
											<span class="rating-percentage-text js-one-stars-percent">%</span>
										</li>
									</ul>
								</div>
							</aside>
							
							<div class="toggle-container filter-toggle filter-toggle--with-text filter-toggle--medium">
								<div class="toggle js-toggle">
									<input id="toggle--show-all" name="radiomedium" data-cloudtotoggle="tag-cloud--all" checked="" type="radio">
									<label for="toggle--show-all">
										All Reviews
									</label>
								</div>
								<div class="toggle js-toggle">
									<input id="toggle--show-five" name="radiomedium" data-cloudtotoggle="tag-cloud--positive" type="radio">
									<label for="toggle--show-five">
										4 - 5 Stars
									</label>
								</div>
								<div class="toggle js-toggle">
									<input id="toggle--show-three" name="radiomedium" data-cloudtotoggle="tag-cloud--average" type="radio">
									<label for="toggle--show-three">
										3 Stars
									</label>
								</div>
								<div class="toggle js-toggle">
									<input id="toggle--show-one" name="radiomedium" data-cloudtotoggle="tag-cloud--negative" type="radio">
									<label for="toggle--show-one">
										1 - 2 Stars
									</label>
								</div>
							</div>
							
							<div class="cloud-key-instruction-container" style="width: auto;">
								<h2 class="cloud-key-instruction">Click a word to read reviews featuring it</h2>
								<h3 class="cloud-key"><span class="size-key">Siz<b>e</b></span> = Frequency</h3>
								<h3 class="cloud-key"><span class="colour-key">Colour</span> = Sentiment</h3>
							</div>

							<div class="page-data-vis-reviews-cloud__cloud-section">
								<div class="tag-cloud-container" style="margin-bottom: 6rem;">
									
									<div class="chart__loading">
										<div class="hamster-wheel">
											<img src="images/hamster-wheel-dark.png" alt="hamster wheel">
										</div>
										<div class="animation-hamster animation-hamster--dark"></div>
									</div>
									
									<div class="chart__no-data">
										<div class="animation-hamster-no-data-dark"></div>
    								<div>
											<h2>No Reviews Found</h2>
											<p>Sorry, we couldn't retrieve any reviews for the chosen app and country. Try changing the app name or the country above.</p>
										</div>
									</div>
									
									<div class="start-instruction">
										<img src="images/onboarding-find-an-app.png" alt="Find an app to get started" />
									</div>
									
									<ul class="tag-cloud tag-cloud--all"></ul>
									<ul class="tag-cloud tag-cloud--positive"></ul>
									<ul class="tag-cloud tag-cloud--average"></ul>
									<ul class="tag-cloud tag-cloud--negative"></ul>
									<div class="reviews-content-container js-reviews-content-container">
										<h2 class="heading-style--heading-five">Latest Reviews Featuring <span class="reviews-content-container__keyword js-keyword">...</span></h2>
										<div class="ratings-list js-custom-scrollbar" data-mcs-theme="minimal-dark">
											<ul class="js-reviews-content">
												<li>
													<h2 class="reviews-content__title">Click a term above to see the reviews it appears in</h2>
												</li>
											</ul>
										</div>
									</div>

<!--
									<div class="feedback-container">
											<svg x="0px" y="0px"
	     viewBox="0 0 58.4 99.6" enable-background="new 0 0 58.4 99.6" xml:space="preserve">
	<path fill="#6D69C5" d="M51.6,70.4c0,12.3-10,22.4-22.4,22.4S6.8,82.8,6.8,70.4H51.6z" class="lab-bottle-liquid" />
	<path fill="#5A5A68" d="M40.6,43.5V8.8h1.7c2.4,0,4.4-2,4.4-4.4S44.7,0,42.3,0H16.1c-2.4,0-4.4,2-4.4,4.4s2,4.4,4.4,4.4h1.1v35
	    C6.7,48.5,0,58.8,0,70.4c0,16.1,13.1,29.2,29.2,29.2c16.1,0,29.2-13.1,29.2-29.2C58.4,58.7,51.3,48,40.6,43.5z M16.1,3h26.1
	    c0.8,0,1.4,0.6,1.4,1.4c0,0.7-0.5,1.2-1.1,1.4H15.9c-0.6-0.1-1.1-0.7-1.1-1.4C14.7,3.6,15.4,3,16.1,3z M29.2,96.6
	    C14.8,96.6,3,84.9,3,70.4c0-10.7,6.4-20.2,16.3-24.3l0.9-0.4V7h17.3v38.6l1,0.4c10.1,3.8,16.9,13.7,16.9,24.5
	    C55.4,84.9,43.7,96.6,29.2,96.6z" />
	</svg>
											<div>
												<h2 class="heading-style--heading-three">Would You Use This Feature?</h2>
												<p>Let us know with this <a href="">quick 2 question survey</a> so we can build it with your help.</p>
											</div>
										</div>

										<div class="idc-comments-container">
											<script>
												var idcomments_acct = 'c4a0cfaab22f16bc5e847b0d1398bb91';
												var idcomments_post_id;
												var idcomments_post_url;
												</script>
												<span id="IDCommentsPostTitle" style="display:none"></span>
											<script type='text/javascript' src='https://www.intensedebate.com/js/genericCommentWrapperV2.js'></script>
										</div>

								</div>
-->
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div class="grid-container global-footer-dark global-footer-dark--lab" id="js-component-import--global-footer"></div>

	<div id="js-component-import--account-container" class="panel-right-container js-account-container"></div>
	<div id="js-component-import--search-container" class="panel-right-container js-search-container"></div>

 	<script src="js/vendor/jquery-1.11.1.min.js"></script>
 	<script src="js/vendor/handlebars-v2.0.0.js"></script> <!-- static templates only -->
 	<script src="js-v2/templates/templates.js"></script> <!-- static templates only -->
 	<script src="js/vendor/modernizr.2.8.3.custom.min.js"></script>

	<script src="js/vendor/jquery.mCustomScrollbar.concat.min.js"></script>

	<div id="js-appendScriptsContainer"></div>

	<script src="js-v2/app-include-templates.js"></script> <!-- static templates only -->
  <script src="js-v2/application.js"></script>
		
	<script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="js/vendor/highslide-software/rounded-corners.js"></script>
  
	<script>
		var chartData = [
    {
        "data": [
            {
                "date": new Date(1420070400000),
                "value": 3.4
            },
            {
                "date": new Date(1420243200000),
                "value": 4.3
            },
            {
                "date": new Date(1420329600000),
                "value": 4.2
            },
            {
                "date": new Date(1420416000000),
                "value": 4
            },
            {
                "date": new Date(1420502400000),
                "value": 3.8
            },
            {
                "date": new Date(1420588800000),
                "value": 3.5
            },
            {
                "date": new Date(1420675200000),
                "value": 3
            },
            {
                "date": new Date(1420761600000),
                "value": 3.2
            },
            {
                "date": new Date(1420848000000),
                "value": 4
            },
            {
                "date": new Date(1420934400000),
                "value": 4.2
            },
            {
                "date": new Date(1421020800000),
                "value": 3.8
            },
            {
                "date": new Date(1421107200000),
                "value": 3.7
            },
            {
                "date": new Date(1421193600000),
                "value": 3.6
            },
            {
                "date": new Date(1421280000000),
                "value": 3.5
            },
            {
                "date": new Date(1421366400000),
                "value": 3.2
            },
            {
                "date": new Date(1421452800000),
                "value": 3.2
            }
        ]
    },
    {
        "data": [
            {
                "date": new Date(1420070400000),
                "value": 5
            },
            {
                "date": new Date(1420156800000),
                "value": 6
            },
            {
                "date": new Date(1420243200000),
                "value": 11
            },
            {
                "date": new Date(1420329600000),
                "value": 15
            },
            {
                "date": new Date(1420416000000),
                "value": 13
            },
            {
                "date": new Date(1420502400000),
                "value": 11
            },
            {
                "date": new Date(1420588800000),
                "value": 9
            },
            {
                "date": new Date(1420675200000),
                "value": 9
            },
            {
                "date": new Date(1420761600000),
                "value": 10
            },
            {
                "date": new Date(1420848000000),
                "value": 12
            },
            {
                "date": new Date(1420934400000),
                "value": 8
            },
            {
                "date": new Date(1421020800000),
                "value": 7
            },
            {
                "date": new Date(1421107200000),
                "value": 5
            }
        ]
    },{
        "data": [
            {
                "date": new Date(1420070400000),
                "value": 5
            },
            {
                "date": new Date(1420156800000),
                "value": 7
            },
            {
                "date": new Date(1420243200000),
                "value": 7
            },
            {
                "date": new Date(1420329600000),
                "value": 8
            },
            {
                "date": new Date(1420416000000),
                "value": 10
            },
            {
                "date": new Date(1420502400000),
                "value": 7
            },
            {
                "date": new Date(1420675200000),
                "value": 6
            },
            {
                "date": new Date(1420761600000),
                "value": 5
            },
            {
                "date": new Date(1420848000000),
                "value": 4
            },
            {
                "date": new Date(1420934400000),
                "value": 3
            },
            {
                "date": new Date(1421020800000),
                "value": 5
            },
            {
                "date": new Date(1421107200000),
                "value": 6
            },
            {
                "date": new Date(1421193600000),
                "value": 8
            },
            {
                "date": new Date(1421280000000),
                "value": 4
            },
            {
                "date": new Date(1421366400000),
                "value": 2
            },
            {
                "date": new Date(1421452800000),
                "value": 3
            },
            {
                "date": new Date(1421539200000),
                "value": 1
            }]
    }];  
		
		var rawReviews = {};

		if (!String.prototype.splice) {
		    String.prototype.splice = function(start, delCount, newSubStr) {
		        return this.slice(0, start) + newSubStr + this.slice(start + Math.abs(delCount));
		    };
		}

		function shuffle(array) {
		  var currentIndex = array.length, temporaryValue, randomIndex;

		  // While there remain elements to shuffle...
		  while (0 !== currentIndex) {

		    // Pick a remaining element...
		    randomIndex = Math.floor(Math.random() * currentIndex);
		    currentIndex -= 1;

		    // And swap it with the current element.
		    temporaryValue = array[currentIndex];
		    array[currentIndex] = array[randomIndex];
		    array[randomIndex] = temporaryValue;
		  }

		  return array;
		}

		function populateReviewsContent(term) {
			// find reviews that contain the term
			$('.js-reviews-content-container').show();
			
			var currentCloud = $('.js-reviews-cloud-filters-row .filter-toggle input:checked').attr("data-cloudtotoggle");
			var filterByRating = null;
			var filterByRatingMin = null;
			var filterByRatingMax = null;
			if(currentCloud == "tag-cloud--positive") {
				filterByRating = true;
				filterByRatingMin = 4;
				filterByRatingMax = 5;
			} else if(currentCloud == "tag-cloud--average") {
				filterByRating = true;
				filterByRatingMin = 3;
				filterByRatingMax = 3;
			} else if(currentCloud == "tag-cloud--negative") {
				filterByRating = true;
				filterByRatingMin = 0;
				filterByRatingMax = 2;
			}
			
			var reviewsToOutput = [];
			var counter = 0;
			for(var i = 0; i < rawReviews.length; i++) {
				if(rawReviews[i].content.toLowerCase().indexOf(term.toLowerCase()) > -1) {
					if(filterByRating == null) {
						reviewsToOutput.push(rawReviews[i]);
						counter++;
					} else {
						if(rawReviews[i].rating >= filterByRatingMin && rawReviews[i].rating <= filterByRatingMax) {
							reviewsToOutput.push(rawReviews[i]);
							counter++;
						}
					}
				}
			}
			
			$('.js-reviews-content').empty();
			$('.js-keyword').text("'" + term + "'");

			for(var i = 0; i < reviewsToOutput.length; i++) {

				var contentString = reviewsToOutput[i].content;
				var indexOfString = reviewsToOutput[i].content.toLowerCase().indexOf(term);
				var wordLength = term.length;
				var formattedContent = contentString.splice(indexOfString + wordLength, 0, "</strong>");
				formattedContent = formattedContent.splice(indexOfString, 0, "<strong>");

				var ratingsContainer = $("<div>").addClass("ratings-container").append($("<div>").addClass("ratings-full").css("width", ((reviewsToOutput[i].rating / 5) * 100) + "%"));
				var reviewTitle = $("<h2>").addClass("reviews-content__title").html(reviewsToOutput[i].title);
				var reviewDate = new Date(reviewsToOutput[i].date);
				var formattedReviewDate = reviewDate.getDate() + "/" + (reviewDate.getMonth()+1) + "/" + reviewDate.getFullYear();
				var reviewDate = $("<span>").addClass("reviews-content__date").text(formattedReviewDate);
				var reviewContent = $("<p>").html(formattedContent);

				$('.js-reviews-content').append($("<li>").append(ratingsContainer)
																									.append(reviewTitle)
																									.append(reviewDate)
																									.append(reviewContent)
																				);
			}
		}
		
		function generateReviewsCloud() {
				
			$('.tag-cloud--all').empty();			
			$('.tag-cloud--positive').empty();
			$('.tag-cloud--average').empty();
			$('.tag-cloud--negative').empty();
			
			$('.is-initial-state').removeClass("is-initial-state")
			$('body').addClass("is-loading-data");
			$('body').removeClass("is-no-data");
			var myHeaders = new Headers();
			var myInit = { method: 'GET',
					 headers: myHeaders,
					 mode: 'cors',
					 cache: 'default',
			};

			var appId = $('.js-app-search-input').attr("data-appid");
			var countryCode = $('.js-dropdown-country .js-dropdown-trigger').attr("data-value");

			fetch('https://stats.reflection.io/microservices/wordcloud?itemid=' + appId + '&country=' + countryCode, myInit).then(function(response) {
				return response.json().then(function(json) {
					if(json.reviewsCloudData) {
						var reviewsCloud = {
							data: json.reviewsCloudData
						};

						rawReviews = json.reviewsRaw;

						if(json.appIcon) {
							$('.js-app-icon').attr("src", json.appIcon);
						}

						$('body').removeClass("is-loading-data");
						$('body').removeClass("is-no-data");
						handleData(reviewsCloud.data);
					} else {
						// show cannot find reviews
						$('body').removeClass("is-loading-data");
						$('body').addClass("is-no-data");
					}
				});
			}).catch(function(error) {
				console.log('There has been a problem with the fetch operation: ' + error.message);
			});
		};
		
		var FilterDropDown = function($domElement) {

			var $thisSelectBox = $domElement,
					$dropDownContainer = $("<ul>").addClass("form-field--select__dropdown"),
					$currentValue = $("<span>").addClass("form-field--select__box ref-icon-after--angle-down js-dropdown-trigger").attr("data-value", "GB");

			$thisSelectBox.find('option').each(function(){
				
				var $thisOption = $(this),
						selectedClass = "",
						cssClass = $thisOption.attr("class");

						if($($thisOption).is(":selected")) {
							if($thisOption.val() != "") {

								selectedClass = "is-selected";
								var countryFlag = $("<span>").addClass(cssClass);
								var triggerText = $("<b>").text($thisOption.text());
								$currentValue.append(countryFlag);
								$currentValue.append(triggerText);
							}
						}

				if($thisOption.val() != "") {

					var accessClass = "";
					if($thisOption.data("access")) {
						accessClass = "ref-icon-after--key";
					}

					var $newListItem = $("<li>");
					$dropDownContainer.append($newListItem
																				.addClass("js-dropdown-option")
																				.addClass(selectedClass)
																				.addClass(accessClass)
																				.attr('data-icon-flag', cssClass)
																				.attr('data-value', $thisOption.attr('value'))
																				.on("click", function() {
																					var $this = $(this);
																					$('.js-dropdown-trigger').attr("data-value", $(this).attr("data-value"));	
																					if($('.js-app-search-input').val()) {
																						generateReviewsCloud();
																					}
																					closeAllFilters();

																					$('.js-dropdown-option.is-selected').removeClass("is-selected");
																					$this.addClass("is-selected");
																					$('.js-dropdown-trigger').empty();
																					var countryIcon = $("<span>").addClass($this.attr("data-icon-flag"));
																					$('.js-dropdown-trigger').append(countryIcon);
																					var triggerText = $("<b>").text($thisOption.text());
																					$('.js-dropdown-trigger').append(triggerText);
																				})
																				.append($("<span>").addClass(cssClass))
																				.append($("<span>").text($thisOption.text()))
																	);
				}
			});

			$currentValue.on("click", function(){
				if(!$thisSelectBox.attr("disabled")) {
					var $parentDiv = $thisSelectBox.parent("div");
					if($parentDiv.hasClass("is-open")) {
						$dropDownContainer.toggle();	
						$parentDiv.toggleClass("is-open");
					} else {
						setTimeout(function(){
							if(!$parentDiv.hasClass("is-open")) {
								closeAllFilters();
							}
							var parentWidth = $parentDiv.width();
							var parentHeight = $parentDiv.height();
							$dropDownContainer.css({"min-width": parentWidth + "px"});
							$dropDownContainer.toggle();	
							$parentDiv.toggleClass("is-open");
						}, 50); // allow time for instance.closeAllFilters() to close other filters first
					}
				}
			});

			if($currentValue.text() == "") {
				$thisSelectBox.parent("div").addClass("nothing-selected");
			}

			$thisSelectBox.parent("div").append($currentValue)
																	.append($dropDownContainer);
		}

		function closeAllFilters() {
			$('.js-secondary-filter.is-open .form-field--select__dropdown').hide();
			$('.js-secondary-filter.is-open').removeClass("is-open");
		}

		function scrollToReviews() {
			var scrollTo = $('.js-reviews-content-container').offset().top;
			$("html, body").animate({scrollTop: scrollTo - 100}, '500');
		}

		function handleData(cloudData) {

			$('.tag-cloud--all').empty();			
			$('.tag-cloud--positive').empty();
			$('.tag-cloud--average').empty();
			$('.tag-cloud--negative').empty();
			$('.js-reviews-content').empty().append($('<li><h2 class="reviews-content__title">Click a term above to see the reviews it appears in</h2></li>'));
		
			var minFontSize = 1,
					maxFontSize = 7;

			var topResultsArray = [];

			for(var t = 0; t < 100 && t < cloudData.length; t++) {
				topResultsArray.push(cloudData[t]);
			}

			// shuffle the sorted results
			shuffle(topResultsArray);
			var highestFrequency = cloudData[0].freq.freq_overall;
			var positiveReviewTotals = [],
				averageReviewTotals = [],
				negativeReviewTotals = [];

			for(var t = 0; t < topResultsArray.length; t++) {
				var fontSize = topResultsArray[t].freq.freq_overall / highestFrequency * maxFontSize + 0.5;
				var total = topResultsArray[t].freq.freq_overall;
				var cssClass = "negative-average";
				if(topResultsArray[t].freq.average_rating > 2.5 && topResultsArray[t].freq.average_rating < 3.5) {
					cssClass = "average-average";
				} else if(topResultsArray[t].freq.average_rating > 3.5) {
					cssClass = "positive-average";
				}
				$('.tag-cloud--all').append(
					$("<li>").addClass(cssClass)
										.text(topResultsArray[t].term)
										.data("font-size", fontSize + "rem")
										.data("index", t)
										.data("total", total)
										.data("average", topResultsArray[t].freq.average_rating)
										.attr("data-term", topResultsArray[t].term)
										.on("mouseenter", function(){
											var thisTerm = $(this).text();
											$('.js-keyword-hover').text("'" + thisTerm + "'");

											var thisIndex = $(this).data("index");
											var totalFromTag = $(this).data("total");
											
											var percFiveStars = Math.round((topResultsArray[thisIndex].freq.freq_5stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
											$('.js-five-stars').text(topResultsArray[thisIndex].freq.freq_5stars);
											$('.js-five-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percFiveStars + "%");
											$('.js-five-stars-percent').text(percFiveStars + "%");

											var percFourStars = Math.round((topResultsArray[thisIndex].freq.freq_4stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
											$('.js-four-stars').text(topResultsArray[thisIndex].freq.freq_4stars);
											$('.js-four-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percFourStars + "%");
											$('.js-four-stars-percent').text(percFourStars + "%");
											
											var percThreeStars = Math.round((topResultsArray[thisIndex].freq.freq_3stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
											$('.js-three-stars').text(topResultsArray[thisIndex].freq.freq_3stars);
											$('.js-three-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percThreeStars + "%");
											$('.js-three-stars-percent').text(percThreeStars + "%");
											
											var percTwoStars = Math.round((topResultsArray[thisIndex].freq.freq_2stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
											$('.js-two-stars').text(topResultsArray[thisIndex].freq.freq_2stars);
											$('.js-two-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percTwoStars + "%");
											$('.js-two-stars-percent').text(percTwoStars + "%");
											
											var percOneStars = Math.round((topResultsArray[thisIndex].freq.freq_1stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
											$('.js-one-stars').text(topResultsArray[thisIndex].freq.freq_1stars);
											$('.js-one-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percOneStars + "%");
											$('.js-one-stars-percent').text(percOneStars + "%");
											
											$('.js-all-stars').text(topResultsArray[thisIndex].freq.freq_overall);
										})
										.on("click", function(){											
											populateReviewsContent($(this).attr("data-term"));
											scrollToReviews();
										})
				);

				positiveReviewTotals.push(topResultsArray[t].freq.freq_5stars + topResultsArray[t].freq.freq_4stars);
				averageReviewTotals.push(topResultsArray[t].freq.freq_3stars);
				negativeReviewTotals.push(topResultsArray[t].freq.freq_2stars + topResultsArray[t].freq.freq_1stars);
			}

			positiveReviewTotals.sort(function(a, b){return b-a});
			averageReviewTotals.sort(function(a, b){return b-a});
			negativeReviewTotals.sort(function(a, b){return b-a});

			var highestPositiveReviewTotal = positiveReviewTotals[0];
			for(var t = 0; t < topResultsArray.length; t++) {
				if(topResultsArray[t].freq.freq_5stars > 0 || topResultsArray[t].freq.freq_4stars > 0) { // create cloud for positive reviews
						var fontSize = (topResultsArray[t].freq.freq_5stars + topResultsArray[t].freq.freq_4stars) / highestPositiveReviewTotal * maxFontSize + 0.5;
						var total = topResultsArray[t].freq.freq_overall;
						$('.tag-cloud--positive').append(
							$("<li>").text(topResultsArray[t].term)
												.data("font-size", fontSize + "rem")
												.data("index", t)
												.data("total", total)
												.attr("data-term", topResultsArray[t].term)
												.on("mouseenter", function(){
													var thisTerm = $(this).text();
													$('.js-keyword-hover').text("'" + thisTerm + "'");

													var thisIndex = $(this).data("index");
													var totalFromTag = $(this).data("total");

													var percFiveStars = Math.round((topResultsArray[thisIndex].freq.freq_5stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
													$('.js-five-stars').text(topResultsArray[thisIndex].freq.freq_5stars);
													$('.js-five-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percFiveStars + "%");
													$('.js-five-stars-percent').text(percFiveStars + "%");

													var percFourStars = Math.round((topResultsArray[thisIndex].freq.freq_4stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
													$('.js-four-stars').text(topResultsArray[thisIndex].freq.freq_4stars);
													$('.js-four-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percFourStars + "%");
													$('.js-four-stars-percent').text(percFourStars + "%");
													
													var percThreeStars = Math.round((topResultsArray[thisIndex].freq.freq_3stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
													$('.js-three-stars').text(topResultsArray[thisIndex].freq.freq_3stars);
													$('.js-three-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percThreeStars + "%");
													$('.js-three-stars-percent').text(percThreeStars + "%");
													
													var percTwoStars = Math.round((topResultsArray[thisIndex].freq.freq_2stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
													$('.js-two-stars').text(topResultsArray[thisIndex].freq.freq_2stars);
													$('.js-two-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percTwoStars + "%");
													$('.js-two-stars-percent').text(percTwoStars + "%");
													
													var percOneStars = Math.round((topResultsArray[thisIndex].freq.freq_1stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
													$('.js-one-stars').text(topResultsArray[thisIndex].freq.freq_1stars);
													$('.js-one-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percOneStars + "%");
													$('.js-one-stars-percent').text(percOneStars + "%");
													
													$('.js-all-stars').text(topResultsArray[thisIndex].freq.freq_overall);

												})
												.on("click", function(){
													populateReviewsContent($(this).attr("data-term"));
													scrollToReviews();
												})
						);
				}
			}

			var highestAverageReviewTotal = averageReviewTotals[0];
			for(var t = 0; t < topResultsArray.length; t++) {
				if(topResultsArray[t].freq.freq_3stars > 0) { // create cloud for average reviews
						var fontSize = (topResultsArray[t].freq.freq_3stars) / highestAverageReviewTotal * maxFontSize + 0.5;
						var total = topResultsArray[t].freq.freq_overall;
						$('.tag-cloud--average').append(
							$("<li>").text(topResultsArray[t].term)
												.data("font-size", fontSize + "rem")
												.data("index", t)
												.data("total", total)
												.attr("data-term", topResultsArray[t].term)
												.on("mouseenter", function(){

													var thisTerm = $(this).text();
													$('.js-keyword-hover').text("'" + thisTerm + "'");

													var thisIndex = $(this).data("index");
													var totalFromTag = $(this).data("total");

													var percFiveStars = Math.round((topResultsArray[thisIndex].freq.freq_5stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
													$('.js-five-stars').text(topResultsArray[thisIndex].freq.freq_5stars);
													$('.js-five-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percFiveStars + "%");
													$('.js-five-stars-percent').text(percFiveStars + "%");

													var percFourStars = Math.round((topResultsArray[thisIndex].freq.freq_4stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
													$('.js-four-stars').text(topResultsArray[thisIndex].freq.freq_4stars);
													$('.js-four-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percFourStars + "%");
													$('.js-four-stars-percent').text(percFourStars + "%");
													
													var percThreeStars = Math.round((topResultsArray[thisIndex].freq.freq_3stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
													$('.js-three-stars').text(topResultsArray[thisIndex].freq.freq_3stars);
													$('.js-three-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percThreeStars + "%");
													$('.js-three-stars-percent').text(percThreeStars + "%");
													
													var percTwoStars = Math.round((topResultsArray[thisIndex].freq.freq_2stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
													$('.js-two-stars').text(topResultsArray[thisIndex].freq.freq_2stars);
													$('.js-two-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percTwoStars + "%");
													$('.js-two-stars-percent').text(percTwoStars + "%");
													
													var percOneStars = Math.round((topResultsArray[thisIndex].freq.freq_1stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
													$('.js-one-stars').text(topResultsArray[thisIndex].freq.freq_1stars);
													$('.js-one-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percOneStars + "%");
													$('.js-one-stars-percent').text(percOneStars + "%");
													
													$('.js-all-stars').text(topResultsArray[thisIndex].freq.freq_overall);

												})
												.on("click", function(){
													populateReviewsContent($(this).attr("data-term"));
													scrollToReviews();
												})
						);
				}
			}

			var highestNegativeReviewTotal = negativeReviewTotals[0];
			for(var t = 0; t < topResultsArray.length; t++) {
				if(topResultsArray[t].freq.freq_2stars > 0 || topResultsArray[t].freq.freq_1stars > 0) { // create cloud for negative reviews
						var fontSize = (topResultsArray[t].freq.freq_2stars + topResultsArray[t].freq.freq_1stars) / highestNegativeReviewTotal * maxFontSize + 0.5;
						var total = topResultsArray[t].freq.freq_overall;
						$('.tag-cloud--negative').append(
							$("<li>").text(topResultsArray[t].term)
												.data("font-size", fontSize + "rem")
												.data("index", t)
												.data("total", total)
												.attr("data-term", topResultsArray[t].term)
												.on("mouseenter", function(){

													var thisTerm = $(this).text();
													$('.js-keyword-hover').text("'" + thisTerm + "'");

													var thisIndex = $(this).data("index");
													var totalFromTag = $(this).data("total");

													var percFiveStars = Math.round((topResultsArray[thisIndex].freq.freq_5stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
													$('.js-five-stars').text(topResultsArray[thisIndex].freq.freq_5stars);
													$('.js-five-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percFiveStars + "%");
													$('.js-five-stars-percent').text(percFiveStars + "%");

													var percFourStars = Math.round((topResultsArray[thisIndex].freq.freq_4stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
													$('.js-four-stars').text(topResultsArray[thisIndex].freq.freq_4stars);
													$('.js-four-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percFourStars + "%");
													$('.js-four-stars-percent').text(percFourStars + "%");
													
													var percThreeStars = Math.round((topResultsArray[thisIndex].freq.freq_3stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
													$('.js-three-stars').text(topResultsArray[thisIndex].freq.freq_3stars);
													$('.js-three-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percThreeStars + "%");
													$('.js-three-stars-percent').text(percThreeStars + "%");
													
													var percTwoStars = Math.round((topResultsArray[thisIndex].freq.freq_2stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
													$('.js-two-stars').text(topResultsArray[thisIndex].freq.freq_2stars);
													$('.js-two-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percTwoStars + "%");
													$('.js-two-stars-percent').text(percTwoStars + "%");
													
													var percOneStars = Math.round((topResultsArray[thisIndex].freq.freq_1stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
													$('.js-one-stars').text(topResultsArray[thisIndex].freq.freq_1stars);
													$('.js-one-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percOneStars + "%");
													$('.js-one-stars-percent').text(percOneStars + "%");
													
													$('.js-all-stars').text(topResultsArray[thisIndex].freq.freq_overall);

												})
												.on("click", function(){
													populateReviewsContent($(this).attr("data-term"));
													scrollToReviews();
												})
						);
				}
			}


			$('.tag-cloud--all').on("mouseleave", function(){
				//TODO empty ratings widget
			});

			setTimeout(function() {
				$('.tag-cloud li').each(function(){
					var $this = $(this);
					$(this).css("font-size", $this.data("font-size"));
				});
			}, 500);
		}

		function populateAppContent(appName, devName, appIconUrl, appLink) {			
			
			var appLink = $("<a>").attr("href", appLink).attr("target", "_blank").text(appName);
			if(devName != undefined) {
				$('.js-developer-name').text(devName);
			}
			if(appIconUrl != undefined) {
				$('.js-app-icon').attr("src", appIconUrl);
			}
			
			var selectedCountry = $('.js-secondary-filter .js-dropdown-trigger b').text();
			$('.js-selected-country-text').text("(" + selectedCountry + ")");
		}
		
		// Utility function
		Date.prototype.addHours= function(h){
      this.setHours(this.getHours()+h);
      return this;
    }
		
		$(window).on("load", function(){
		  new Page();
			$("body").on("click", function(){
				$('.js-search-results-drop-down').hide();
			});
			$('.js-select-box').each(function() {
  			new FilterDropDown($(this));
  		});
			
			var typingTimer;
			
			$('.js-app-search-input').keyup(function(){
				
				$('.js-search-results-drop-down').show();
				$('.js-app-search-loading-indicator').show();
				$('.js-search-results-drop-down li').remove();

				if(typingTimer) {
					clearTimeout(typingTimer);
				}

				var valueToSearch = $(this).val();
				typingTimer = setTimeout(function(){
					var myHeaders = new Headers();
					// myHeaders.append('Authorization', 'Basic ZWxhc3RpYzplWFBsSTUxeFU2Z29OOTI3');
					myHeaders.append('Content-Type', 'application/json');

					 var myInit = { method: 'POST',
						 headers: myHeaders,
						 mode: 'cors',
						 cache: 'default',
						 body: JSON.stringify({
								"query": {
									"function_score": {
										"query": {
											"match": {
												"application_name": {
													"query": valueToSearch,
													"fuzziness": "AUTO"
												}
											}
										},
										"script_score": {
											"script": {
												"inline": "Math.log(2 + doc['downloads'].value + doc['revenue'].value) + _score * 2.5"
											}
										}
									}
								}
							})
					 };
					
					var myInitNewSearchURL = { method: 'GET',
						 headers: myHeaders,
						 mode: 'cors',
						 cache: 'default',
					 };
					// previous search URL https://es.reflection.io:9200/ios/_search
					
					fetch('https://oli-4395-dot-reflection-live.appspot.com/webapp/search/iosapp?term=' + valueToSearch, myInitNewSearchURL).then(function(response) {
						console.log(response);
						return response.json().then(function(json) {
							console.log(json);
							if(json && json.data && json.data.length) {
								
								var searchResultsDropDown = $('.js-search-results-drop-down');
								$.each(json.data, function(i, result){
									// console.log(result);
									searchResultsDropDown.append($("<li>").attr("data-appid", result.appId).attr("data-appDeveloper", result.developerName).append($("<img>").attr("src", result.appIcon)).append($("<span>").text(result.appName)).on("click", function(){
										var $this = $(this);
										var selectedAppId = $this.attr("data-appId");										
										var selectedAppName = $this.text();
										var selectedAppDeveloper = $this.attr("data-appDeveloper");
										$('.js-app-search-input').val(selectedAppName).attr("data-appId", selectedAppId);
										$('.js-search-results-drop-down').hide();
										populateAppContent(result.appName, result.developerName, result.appIcon, "https://www.reflection.io/#app:%7B%22countryRankHistory%22:%22gb%22,%22store%22:%22iOS%22,%22appTab%22:%22ratings_and_info%22,%22iosDeviceRankHistory%22:%22iPhone%22,%22myData%22:false,%22appId%22:%22" + selectedAppId + "%22,%22countriesRevenueDownloads%22:%5B%22au%22,%22br%22,%22ca%22,%22dk%22,%22fr%22,%22de%22,%22id%22,%22ie%22,%22it%22,%22my%22,%22mx%22,%22nz%22,%22no%22,%22pt%22,%22ru%22,%22sa%22,%22sg%22,%22es%22,%22se%22,%22tr%22,%22ae%22,%22gb%22,%22us%22%5D,%22iosDeviceRevenueDownloads%22:%5B%22iPhone%22,%22iPad%22,%22DesktopIos%22,%22OtherIosDevices%22%5D%7D");	
										generateReviewsCloud();
									}));
									
									$('.js-app-search-loading-indicator').hide();
								});
							}
						});
					}).catch(function(error) {
						console.log('There has been a problem with the fetch operation: ' + error.message);
					});
				}, 500);
			});

			$('.js-toggle input').each(function(){
				var cloudToToggle = $(this).data("cloudtotoggle");
				if($(this).is(":checked")) {
					$('.' + cloudToToggle).fadeIn();
				} else {
					$('.' + cloudToToggle).hide();
				}
			});

			$('.js-toggle input').change(function(){
				var cloudToToggle = $(this).data("cloudtotoggle");
				if($(this).is(":checked")) {
					$('.tag-cloud').hide();
					$('.' + cloudToToggle).fadeIn();
				}
			});

  		$("html").on("click", function(e){
				if(!$(e.target).hasClass("js-no-close-on-click") && !$(e.target).hasClass("js-clear-all")) {
					closeAllFilters();
				}
			});
			
			
			// HIGHCHARTS
  		var monthNames = [
        "Jan", "Feb", "Mar",
        "Apr", "May", "Jun", "Jul",
        "Aug", "Sep", "Oct",
        "Nov", "Dec"
      ];

      var hasBeenSet = false,
      		lastPoint;

	    (function (H) {

	      var customIconRect;
	      H.wrap(H.Tooltip.prototype, 'refresh', function (proceed) {
	      	
	        proceed.apply(this, Array.prototype.slice.call(arguments, 1));

	        if(this.chart.customIconRect !== undefined) {
	          this.chart.customIconRect.destroy();
	        }

	        var $axisLabel = $(this.chart.container).find('.highcharts-axis-label'),
	            leftOffset = 29,
	            axisLabelYPos = $("#" + arguments[1][0].series.chart.container.id + "").height() - arguments[1][0].series.xAxis.bottom,
	            //axisLabelYPos = arguments[1][0].series.chart.containerHeight - arguments[1][0].series.xAxis.bottom,
	            axisLabelXPos = arguments[1][0].plotX - leftOffset,
	            timeStampString = arguments[1][0].x + "",
	            timeStampString = timeStampString.substring(0,10),
	            xAxisDate = new Date(timeStampString*1000).addHours(12),
	            formattedDate = xAxisDate.getDate() + " " + monthNames[xAxisDate.getMonth()];

	        if($axisLabel.length > 0) {       

	          var labelYPos = axisLabelYPos + 18,
	              labelXPos = axisLabelXPos + 7;

	          $axisLabel.attr("transform", "translate(" + labelXPos + "," + labelYPos + ")");
	          $axisLabel.find("text").text(formattedDate);

	        } else {
	          this.chart.renderer.label(formattedDate, axisLabelXPos+7, axisLabelYPos + 18, 'callout', 0, 0, false, true, "axis-label")
	          .css({
	            color: '#fcfdfd',
	            fontSize: '12px',
	            fontFamily: 'Source Sans Pro',
	            fontWeight: 600
	          })
	          .attr({
	            zIndex: 100
	          })
	          .add();
	        }

	        this.chart.customIconRect = this.chart.renderer.image('images/axis-label-background.png', axisLabelXPos, axisLabelYPos + 4, 54, 20)
	        .attr({
	          zIndex: 99
	        })
	        .add();
	      });

				H.wrap(H.Series.prototype, 'hide', function (proceed) {

				  // Before the hide function
				  var t = $(this),
				  				par;

				  if(t[0].type == "area") {
				  	if(this.graph != undefined) {
				  		par = $(this.graph.element).parents('.highcharts-series').attr("class", "highcharts-series is-transparent-fade");
				  	}				  	
				  }

				  var instance = this;
				
				  setTimeout(function() {
				  	proceed.apply(instance, Array.prototype.slice.call(arguments, 1));
				  	if(t[0].type == "area" && par != undefined) {
				  		par.attr("class", "highcharts-series");
				  	}
				  }, 200);
				});

				H.Chart.prototype.animateSelectedLines = function(containerId, indexToSelect, previousSelectedIndex) {
	    		$(containerId + ' .highcharts-series path:nth-child(2)').each(function(){
	          var $this = $(this);
	          if($this.attr("data-index") == indexToSelect) {
	            $this.css("opacity", "0.3");
	            $this.animate({ "opacity": 1 }, 250);
	            $this.siblings("path").css("opacity", "0");
	            $this.siblings("path").animate({ "opacity": 1 }, 250);

	          } else if($this.attr("data-index") == previousSelectedIndex) {
	          	$this.css("opacity", 1);
	            $this.animate({ "opacity": 0.3 }, 250);
	            $this.siblings("path").css("opacity", 1);
	            $this.siblings("path").animate({ "opacity": 0 }, 250);
	          }
	        });
	    	}

	    	H.Chart.prototype.setSeriesToSelected = function(chartIndex, seriesIndex) {
	    		H.charts[chartIndex].series[seriesIndex].selected = true;
	    		if(H.charts[chartIndex].series[seriesIndex].graph) {
	    			H.charts[chartIndex].series[seriesIndex].graph.element.setAttribute("data-selected", "selected");
	    		}	      	
	    	}

	    	H.Chart.prototype.setSeriesToUnselected = function(chartIndex, seriesIndex) {
	    		$('.chart[data-highcharts-chart="' + chartIndex + '"] .highcharts-series path[data-selected]').removeAttr("data-selected");
	      	H.charts[chartIndex].series[seriesIndex].selected = false;
	    	}

	    	H.Chart.prototype.setGraphCSSClasses = function() {
	   			$.each(H.charts, function(key, chart) {
						$.each(chart.series, function (key, series) {
							series.refseriesindex = key;
							if(series.graph) {
								series.graph.element.setAttribute("class", "series-class-" + key);
					    	series.graph.element.setAttribute("data-index", key);
							}
						});

						// set CSS classes on the area fills
						$('.chart[data-highcharts-chart="' + key + '"] .highcharts-series path:nth-child(2)').each(function(){
		          var lineIndex = $(this).attr("data-index");
		          $(this).parent('.highcharts-series').find('path:first-child').attr("class", "series-fill-" + lineIndex);
		        });
					});
	   		}

	   		H.Chart.prototype.resetLineStyling = function() {
					$.each(H.charts, function(key, chart) {
						$.each(chart.series, function (key, series) {
							if(series.graph != undefined) {
								if(series.selected) {
									series.graph.element.setAttribute("style", "opacity: 1");
		        			series.graph.parentGroup.element.children[0].setAttribute("style", "opacity: 1");
								} else {
									series.graph.element.setAttribute("style", "opacity: 0.3");
		        			series.graph.parentGroup.element.children[0].setAttribute("style", "opacity: 0");
								}						
							}							
						});  	
					});
				}

				H.Chart.prototype.setFirstVisibleSeriesToSelected = function() {
					// set first visible line of each chart to be selected
					$.each(H.charts, function(key, chart) {
						for(var s = 0; s < chart.series.length; s++) {
							if(chart.series[s].visible == true) {
								chart.series[s].graph.element.setAttribute("data-selected", "selected");
	      				chart.series[s].selected = true;
								break;
							}
						}
					});
				}

				H.Chart.prototype.setGraphFillsTransparency = function() {
					$.each(H.charts, function(key, chart) {
						$.each(chart.series, function (key, series) {
							if(series.graph != undefined) {
		        		series.graph.parentGroup.element.children[0].setAttribute("style", "opacity: 0.25");
							}
						});  	
					});
				}

				H.Chart.prototype.highlightAChartSeries = function(chartContainerId, seriesToHighlight) {
				$('#' + chartContainerId + ' .series-class-' + seriesToHighlight).each(function(){
					var $this = $(this);
					$this.css("opacity", 0.3);
          $this.animate({ "opacity": 1 }, 100);
				});
			}

			H.Chart.prototype.unhighlightAChartSeries = function(chartContainerId, seriesToUnhighlight) {
				$('#' + chartContainerId + ' .series-class-' + seriesToUnhighlight).each(function(){
					var $this = $(this);
					$this.css("opacity", "1");
          $this.animate({ "opacity": 0.3 }, 100);
				});
			}

	    }(Highcharts));

	    
	    // generateChart is template only to speed up generating three charts in the template
	    function generateChart(containerId, dataType, seriesData, seriesColour, chartType) {

	    	var seriesColour,
	    			seriesArray = [];

				// TEMPLATE ONLY: Create mock series
				for(var a = 0; a < seriesData.length; a++) {

					var seriesName = dataType;
					if(a == 0) {
						seriesName += "-total";
					}

					seriesArray.push({
						yAxis: (a == 0) ? 1 : 0,
						name: seriesName,
						id : seriesName,
						type: (a == 0) ? 'area' : 'area',
						stacking: null,
						color: (dataType == "downloadsseries" && a == 0) ? "#918edf" : seriesColour[a],
						data: seriesData[a],
						borderRadiusTopLeft: 3,
						borderRadiusTopRight: 3,
						pointStart: Date.UTC(2016, 0, 1),
						pointInterval: 24 * 3600 * 1000, // one day
						lineColor: (dataType == "downloadsseries" && a == 0) ? "#918edf" : seriesColour[a],
						lineWidth: 3,
						lineWidthPlus: 0,
						fillOpacity: 0,
						fillColor: {
							linearGradient: { x1: 0, x2: 0, y1: 0, y2: 1 },
							stops: [
								[0, 'rgba(109,105,197,0.1)'],
								[1, 'rgba(27,199,159,0.1)']
							]
						},
						marker: {
							enabled: false,
							states: {
								hover: {
									enabled: true,
									lineWidth: 0,
									lineWidthPlus: 0,
									radius: 4,
									radiusPlus: 0,
								}
							}
						}
					});
				}

	    	// Generate Demo Chart, using the properties set above
				var chart = new Highcharts.Chart({
					chart: {
	          renderTo: containerId,
						marginLeft: 0,
						marginRight: 0,
						marginBottom: 0,
						marginTop: 0,
						spacing: [0,0,0,0],
						height: 306,
						backgroundColor: '#343438',
						plotBackgroundColor: '#343438',
			   		type: chartType,
			   		animation: false,
			   		style: {
	            fontFamily: 'Source Sans Pro'
	          },
	          events: {
	            load: function() {
	                var countIndex = 0;
	                var graphPointAnimationDelay = 20;

	                // set the all series opacity on load
	                var countIndex = 0;
	                $('#' + containerId + ' .highcharts-series path:nth-child(2)').each(function() { // gets each series line
	                  if (countIndex > 0) { // first series is set to visible
	                    $(this).attr("style", "opacity: 0.3");
	                    $(this).siblings("path").attr("style", "opacity: 0");
	                  } else {
	                    $(this).attr("style", "opacity: 1");
	                  }
	                  countIndex++;
	                });
	            }
	          }
				  },
				  legend: {
				  	enabled: false
				  },
				  title: {
	            text: ''
	        },
	        yAxis: [{
						gridLineColor: '#29292C',
						title: {
							text: null
						}         
					}, {
						gridLineWidth: 0,
						opposite: true
					}],
	        xAxis: {
	        	lineColor: 'red',
	        	startOnTick: true,
	        	endOnTick: true,
	        	showFirstLabel: false,
	          maxPadding: 0,
	          minPadding: 0,
	          type: 'datetime',
	          dateTimeLabelFormats: {
	              day: '%e %b'
	          },
	          tickmarkPlacement: 'on',
	          tickPixelInterval: 30,
	          tickLength: 0,
	          labels: {
	          	align: 'center',
	            x: 0,
	            y: 18,
	            step: 2,
	            style: {
	              color: '#81879D',
	              fontSize: "12px"
	            }
	          },
	        },
	        plotOptions: {
	        	area: {
	            trackByArea: true,
	        		tooltip: {
	        			followPointer: true
	        		},
	        		states: {
	        			hover: {
	        				halo: {
	        					size: 0
	        				},
	        				lineWidthPlus: 0
	        			}
	        		},
	        		marker: {
	        			symbol: "circle"
	        		}		
	        	},
	        	bar: {
	        		borderColor: "#343438",
	        		borderWidth: 1,
	        		groupPadding: 0.08,
	        		pointPadding: 0,
	        		states: {
	        			hover : {
	        				brightness: 0.1
	        			}
	        		}
	        	},
	          series: {
	            events: {
	              click: function() { // clicking on a series selects it and highlights it

	              	// on selecting a series, previously selected series need to be set to unselected, on all charts
	                var that = this,
	                		indexToSelect = that.refseriesindex;

	                if(!that.selected) { // if user clicked on a line that isn't currently selected

	                	// get the index of the previously selected line
	                	var previousSelectedIndex = $('#' + containerId + ' .highcharts-series path[data-selected]').attr("data-index");

	                		// set the previously selected line to unselected
	                		if(previousSelectedIndex != undefined) {
	                			that.chart.setSeriesToUnselected(that.chart.index, previousSelectedIndex);
	                		}

		                	// set the clicked line to selected
		                	that.selected = true;
		                	that.graph.element.setAttribute("data-selected", "selected");

		                	// animate the selected line change
		                	that.chart.animateSelectedLines('#' + containerId, indexToSelect, previousSelectedIndex);

			                // Update all other charts with the selection
			                if(that.chart.index < 2) { // currently viewing the twin charts
			                	
			                	// get the index of the other twin chart
			                	var mirrorChartIndex = (that.chart.index == 0) ? 1 : 0;

			                	// remove previously selected from twin chart
			                	if(previousSelectedIndex != undefined) {
			                		that.chart.setSeriesToUnselected(mirrorChartIndex, previousSelectedIndex);                	
				                }

			                	// get the previously selected line on the combined chart
			                	// and remove previously selected state from combined chart
			                	var previousSelectedIndexOnCombined = $('.chart[data-highcharts-chart="2"] .highcharts-series path[data-selected]').attr("data-index");

			                	if(previousSelectedIndexOnCombined != undefined) {
			                		that.chart.setSeriesToUnselected(2, previousSelectedIndexOnCombined);
			                	}

			                	// set the clicked line to selected on the twin chart
			                	that.chart.setSeriesToSelected(mirrorChartIndex, indexToSelect);

			                	// set the clicked line to selected on the combined chart
			                	var indexToSelectOnCombinedChart = indexToSelect * 2;

			                	that.chart.setSeriesToSelected(2, indexToSelectOnCombinedChart);

			                	// animate the selected line change on the mirrored and combined charts
			                	that.chart.animateSelectedLines('.chart[data-highcharts-chart="' + mirrorChartIndex + '"]', indexToSelect, previousSelectedIndex);
			                	that.chart.animateSelectedLines('.chart[data-highcharts-chart="2"]', indexToSelectOnCombinedChart, previousSelectedIndexOnCombined);
			                
			                } else { 
												
												// using the combined chart, so select the same for the twin charts
												if(previousSelectedIndex != undefined) {
			                		var correspondingIndexOfPreviouslySelectedOnTwinCharts = Math.floor(previousSelectedIndex / 2); // (combined has twice the series lines as a twin chart)

			                		// unselect the previously selected line on twin charts
			                		that.chart.setSeriesToUnselected(0, correspondingIndexOfPreviouslySelectedOnTwinCharts);
			                		that.chart.setSeriesToUnselected(1, correspondingIndexOfPreviouslySelectedOnTwinCharts);
				                }

				                var correspondingIndexToSelectOnTwinCharts = Math.floor(indexToSelect/2);

			                	// set the clicked line to selected on the twin charts
			                	that.chart.setSeriesToSelected(0, correspondingIndexToSelectOnTwinCharts);
			                	that.chart.setSeriesToSelected(1, correspondingIndexToSelectOnTwinCharts);

			                	// animate the selected line change on the mirrored chart
			                	that.chart.animateSelectedLines('.chart[data-highcharts-chart="0"]', correspondingIndexToSelectOnTwinCharts, correspondingIndexOfPreviouslySelectedOnTwinCharts);

			                	that.chart.animateSelectedLines('.chart[data-highcharts-chart="1"]', correspondingIndexToSelectOnTwinCharts, correspondingIndexOfPreviouslySelectedOnTwinCharts);
			                }
	                	}
	              },
	            },
	            animation: false
	          },
	      	},
	        series: seriesArray,
	        tooltip: {
	        	useHTML: true,
	        	shared: true,
	          formatter: function() {	          	
	          	Highcharts.charts[0].series[0].test = "something";
	            var instance = this;
	            var s = "";
	            var thisPointIndex = instance.points[0].point.index;
	            // for stacked percentage
	            // TO DO - bug if first line is off
	            var thisPointTotalValue = 2000; //instance.points[0].series.chart.series[0].data[thisPointIndex].y;

	            $.each(instance.points, function (index, value) {
	                var chartSeries = value.series;
	                var imgString = "",
	                		storeString = ""
	                		valueString = "",
	                		stackedString = "";

									var appIcon = chartSeries.appIcon;
									var store = chartSeries.appStore;
	                
	                var seriesClassName = chartSeries.name;
	                if(seriesClassName == "revenueseries-total") {
	                	seriesClassName = "revenueseries";
	                } else if(seriesClassName == "downloadsseries-total") {
	                	seriesClassName = "downloadsseries";
	                }

	                if($('#toggle--show-stacked').is(":checked") && thisPointTotalValue != undefined) {
	                	var percentageOfTotal = parseInt(value.y / thisPointTotalValue * 100);
	                	stackedString = "<span class='chart-tooltip-percentage' style='background-color: " + chartSeries.color + "'>" + percentageOfTotal + "%</span>";
	                }

	                s += '<div class="custom-tooltip ' + seriesClassName + '" style="background-color: ' + chartSeries.color + '">' + storeString + '<span class="chart-tooltip-value">' + valueString + value.y + '</span>' + stackedString + '</div>';
	            });
	            return s;
	          },
	        	backgroundColor: 'transparent',
	          borderWidth: 0,
	          borderColor: '#dae3ed',
				    crosshairs: [{
	            width: 1,
	            color: '#9ea7c4'
	          }],
	          shadow: {
	            color: 'rgba(0,0,0,0.24)',
	            width: 0,
	            offsetX: 1,
	            offsetY: 1
	        	},
	        	snap: 25,
	        	// the positioner callback could be used in future for the combined chart where it goes off the left of the graph
	        	// positioner: function (labelWidth, labelHeight, point) {
          //     console.log("labelWidth = " + labelWidth);
          //     console.log("labelHeight = " + labelHeight);
          //     console.log(point);
          //     return { x: point.plotX, y: 0 };
          //   },
	        }
		    });

			} // end generateChart()
			
			
			function handleChartInteraction() {
				
				handleCustomLegendInteraction();
//				handleShowBarChart();
//				handleShowAreaChart();
//				handleShowStackedAreaChart();
//
//				handleAddSeriesTest();
//				handleRemoveSeriesTest();

				// handleChartEvents();
			}

			function handleMouseEnterChartKeyLabel($label) {
				if($('html.no-touch').length) {
					var $this = $label.siblings("input");
					var chartToHoverIndex = $this.attr("data-chart-index");
					var seriesToHover = $this.attr("data-series-index");

					var seriesToHoverArray = [seriesToHover];

					if(chartToHoverIndex < 2) { // if it's the twin chart

						for (var ch = 0; ch < 2; ch++) { // for each of the twin charts

							var chartContainerId = Highcharts.charts[ch].container.id;

							var selectedLine = $('#' + chartContainerId + ' .highcharts-series path[data-selected]').attr("data-index");

							for(var i = 0; i < seriesToHoverArray.length; i++) { // highlight one or more lines on same chart

								if(selectedLine != undefined) { // if there is a selected line, it's the area chart, just highlight the line
									if(!Highcharts.charts[ch].series[seriesToHoverArray[i]].selected) {
										Highcharts.Chart.prototype.highlightAChartSeries(chartContainerId, seriesToHoverArray[i]);
									}

								} else { // otherwise it's the stacked chart, just highlight the fill

									$('#' + chartContainerId + ' .series-fill-' + seriesToHoverArray[i]).each(function(){
										var $this = $(this);
										$this.css("opacity", 0.25);
				            $this.animate({ "opacity": 0.6 }, 100);
									});
								}
							}
						}
					} else { // user is hovering over combined chart key label
						// get the corresponding line to hover
						if(seriesToHover != 0 && seriesToHover != 1) {
							seriesToHoverArray.push(seriesToHover - 1);
						}
						var chartContainerId = Highcharts.charts[chartToHoverIndex].container.id;

						for(var i = 0; i < seriesToHoverArray.length; i++) {
							if(!Highcharts.charts[2].series[seriesToHoverArray[i]].selected) {
								Highcharts.Chart.prototype.highlightAChartSeries(chartContainerId, seriesToHoverArray[i]);
							}
						}
					}
				}
			}

			function handleMouseLeaveChartKeyLabel($label) {
				if($('html.no-touch').length) {
					var $this = $label.siblings("input");
					var chartToHoverIndex = $this.attr("data-chart-index");
					var seriesToHover = $this.attr("data-series-index");
					var seriesToHoverArray = [seriesToHover];

					if(chartToHoverIndex < 2) { // if it's the twin chart
						for (var ch = 0; ch < 2; ch++) { // for each of the twin charts

							var chartContainerId = Highcharts.charts[ch].container.id;
							var selectedLine = $('#' + chartContainerId + ' .highcharts-series path[data-selected]').attr("data-index");

							for(var i = 0; i < seriesToHoverArray.length; i++) { // highlight one or more lines on same chart
								if(selectedLine != undefined) { // if there is a selected line, it's the area chart, just highlight the line
									if(!Highcharts.charts[ch].series[seriesToHoverArray[i]].selected) {
										Highcharts.Chart.prototype.unhighlightAChartSeries(chartContainerId, seriesToHoverArray[i]);
									}
								} else { // otherwise it's the stacked chart, just highlight the fill

									$('#' + chartContainerId + ' .series-fill-' + seriesToHoverArray[i]).each(function(){
										var $this = $(this);
										$this.css("opacity", 0.6);
				            $this.animate({ "opacity": 0.25 }, 100);
									});
								}
							}
						}
					} else { // it's the combined chart
						
						// get the corresponding line to hover
						if(seriesToHover != 0 && seriesToHover != 1) {
							seriesToHoverArray.push(seriesToHover - 1);
						}
						var chartContainerId = Highcharts.charts[chartToHoverIndex].container.id;

							for(var i = 0; i < seriesToHoverArray.length; i++) {
								if(!Highcharts.charts[2].series[seriesToHoverArray[i]].selected) {
									Highcharts.Chart.prototype.unhighlightAChartSeries(chartContainerId, seriesToHoverArray[i]);
								}
							}
					}
				}
			}
			
						function handleCustomLegendInteraction() {

				// Hide/show series from custom legend
				$('.js-custom-chart-key').on("click", '.js-toggle-series', function(){ // for each current or new '.js-toggle-series' (checkbox in the legend)

					var $this = $(this);
					var chartIndex = $this.attr("data-chart-index");
					var seriesIndex = $this.attr("data-series-index");					

					var currentChartType = "area";
					$('.toggle input[type=radio][name=charttype]').each(function(){
						if($(this).is(":checked")) {
							currentChartType = $(this).attr("data-chart-type");
						}
					});

					if(chartIndex < 2) { // user is using the twin chart

						if($(this).is(":checked")) {
							// turn on same series on both twin charts
							Highcharts.charts[0].series[seriesIndex].show();
							Highcharts.charts[1].series[seriesIndex].show();

							// turn on the combined chart corresponding series
							Highcharts.charts[2].series[seriesIndex * 2].show();
							Highcharts.charts[2].series[(seriesIndex * 2) + 1].show();

							// only reset styles for non-stacked area chart
							setTimeout(function(){
								if(!$('#toggle--show-stacked').is(":checked") && currentChartType == "area") {
									Highcharts.Chart.prototype.setGraphCSSClasses();
									Highcharts.Chart.prototype.resetLineStyling();
								} else {
									Highcharts.Chart.prototype.setGraphCSSClasses();
									Highcharts.Chart.prototype.setGraphFillsTransparency();
								}
							}, 200);

							// turn off other checkboxes in mirror chart key
							$('.js-twin-chart-container .js-toggle-series').each(function(){
								var $thisToggle = $(this);
								if(!$thisToggle.is($this)) {
									if($thisToggle.attr("data-series-index") == seriesIndex) {
										$thisToggle[0].checked = true;
									}
								}
							});

							// combined chart turn on/off corresponding series
							$('.js-combined-chart-container .js-toggle-series').each(function(){
								var $thisToggle = $(this);
								if(!$thisToggle.is($this)) {
									if($thisToggle.attr("data-series-index") == seriesIndex * 2 || $thisToggle.attr("data-series-index") == (seriesIndex * 2) + 1) {
										$thisToggle[0].checked = true;
									}
								}
							});

						} else { // turn off the series on all charts
							setTimeout(function(){
								
								var isStackedChart = true;
								if(currentChartType == "area") {

									// If the line being turned off is selected then unselect, and select first visible line
									if(Highcharts.charts[0].series[seriesIndex].selected == true) {
										
										isStackedChart = false;

										// unselect for twin charts
										Highcharts.Chart.prototype.setSeriesToUnselected(0, seriesIndex);
										Highcharts.Chart.prototype.setSeriesToUnselected(1, seriesIndex);

										// unselect for combined chart
										var previousSelectedIndexOnCombined = $('.chart[data-highcharts-chart="2"] .highcharts-series path[data-selected]').attr("data-index");

										Highcharts.Chart.prototype.setSeriesToUnselected(2, previousSelectedIndexOnCombined);
									}
								}

								// Hide the series
								Highcharts.charts[0].series[seriesIndex].hide();
								Highcharts.charts[1].series[seriesIndex].hide();

								// hide on the combined chart
								Highcharts.charts[2].series[seriesIndex * 2].hide();
								Highcharts.charts[2].series[(seriesIndex * 2) + 1].hide();

								setTimeout(function(){
									if(!isStackedChart) {
										Highcharts.Chart.prototype.setFirstVisibleSeriesToSelected();
										Highcharts.Chart.prototype.setGraphCSSClasses();
						        Highcharts.Chart.prototype.resetLineStyling();
									}
								}, 200);
							}, 200);

							// turn off other checkboxes in mirror chart key
							$('.js-twin-chart-container .js-toggle-series').each(function(){
								var $thisToggle = $(this);
								if(!$thisToggle.is($this)) {
									if($thisToggle.attr("data-series-index") == seriesIndex) {
										$thisToggle[0].checked = false;
									}
								}
							});

							// combined chart turn on/off corresponding series
							$('.js-combined-chart-container .js-toggle-series').each(function(){
								var $thisToggle = $(this);
								if(!$thisToggle.is($this)) {
									if($thisToggle.attr("data-series-index") == seriesIndex * 2 || $thisToggle.attr("data-series-index") == (seriesIndex * 2) + 1) {
										$thisToggle[0].checked = false;
									}
								}
							});

						}

					} else { // user is using combined chart

						if($(this).is(":checked")) {
							Highcharts.charts[2].series[seriesIndex].show();

							// if both rev and dloads are selected on combined, turn that series on on the twin charts
								
							// get the corresponding series to see if it's visible
							var correspondingSeriesIndex,
									isDownloadsSeriesBeingTurnedOn = seriesIndex % 2 == 1;

							if(isDownloadsSeriesBeingTurnedOn) {
								correspondingSeriesIndex = seriesIndex - 1;
							} else {
								correspondingSeriesIndex = parseInt(seriesIndex) + 1;
							}

							var isCorrespondingSeriesVisible = Highcharts.charts[2].series[correspondingSeriesIndex].visible;

							if(isCorrespondingSeriesVisible) {

								// make sure correspondingTwinIndex is set to corresponding twin chart index
								var correspondingTwinIndex;
								if(isDownloadsSeriesBeingTurnedOn) {
									correspondingTwinIndex = (seriesIndex - 1) / 2;
								} else {
									correspondingTwinIndex = seriesIndex / 2
								}

								// turn it on on the twin chart
								Highcharts.charts[0].series[correspondingTwinIndex].show();
								Highcharts.charts[1].series[correspondingTwinIndex].show();

								// set the key toggle
								$('.js-twin-chart-container .js-toggle-series').each(function(){
									var $thisToggle = $(this);
									if(!$thisToggle.is($this)) {
										if($thisToggle.attr("data-series-index") == correspondingTwinIndex) {
											$thisToggle[0].checked = true;
										}
									}
								});
							}

							// if non-stacked area chart, reset CSS styles/classes
							if(!$('#toggle--show-stacked').is(":checked") && currentChartType == "area") {
								Highcharts.Chart.prototype.setGraphCSSClasses();
								Highcharts.Chart.prototype.resetLineStyling();
							} else {
								Highcharts.Chart.prototype.setGraphCSSClasses();
								Highcharts.Chart.prototype.setGraphFillsTransparency();
							}

						} else {
							setTimeout(function(){

								// If series is selected, select next visible series
								var isStackedChart = true;

								var correspondingTwinIndex;
								if(seriesIndex % 2 == 1) {
									correspondingTwinIndex = (seriesIndex - 1) / 2;
								} else {
									correspondingTwinIndex = seriesIndex / 2
								}

								if(currentChartType == "area") {

									if(Highcharts.charts[2].series[seriesIndex].selected == true) {
										
										isStackedChart = false;

										Highcharts.Chart.prototype.setSeriesToUnselected(2, seriesIndex);

										// Deselect the equivalent line on the twin charts
										Highcharts.Chart.prototype.setSeriesToUnselected(0, correspondingTwinIndex);
										Highcharts.Chart.prototype.setSeriesToUnselected(1, correspondingTwinIndex);
									}
								}

								// Hide the series
								Highcharts.charts[2].series[seriesIndex].hide();
								Highcharts.charts[0].series[correspondingTwinIndex].hide();
								Highcharts.charts[1].series[correspondingTwinIndex].hide();

								// set the key toggle
								$('.js-twin-chart-container .js-toggle-series').each(function(){
									var $thisToggle = $(this);
									if(!$thisToggle.is($this)) {
										if($thisToggle.attr("data-series-index") == correspondingTwinIndex) {
											$thisToggle[0].checked = false;
										}
									}
								});

								setTimeout(function(){
									if(!isStackedChart) {
										Highcharts.Chart.prototype.setFirstVisibleSeriesToSelected();
										Highcharts.Chart.prototype.setGraphCSSClasses();
						        Highcharts.Chart.prototype.resetLineStyling();					
									}
								}, 200);
							}, 200);
						}
					}		
				});

				// hover on/off key to highlight lines
				$('.js-hover-series').on("mouseenter", function(){					
					handleMouseEnterChartKeyLabel($(this));
				}).on("mouseleave", function(){
					handleMouseLeaveChartKeyLabel($(this));
				});
			}
			
			function addAppDataToSeries() {
				// add the app icon and store to the Highcharts series objects for the tooltip

				// template only, mock data
				$.each(Highcharts.charts[0].series, function (key, series) { // twin chart
					series.appIcon = seriesAppIcons[key].icon;
					series.appStore = seriesAppIcons[key].store;
				});
			}

			// Generate Demo Charts
			var mockDataRevenue = [],
					mockDataDownloads = [];

			var seriesColours = ["#f5c943", "#1BC79F", "#FF496A", "#7fb1d5", "#f2bdd8", "#c7b299", "#bd7ebf", "#8bd4c7", "#ffb55a", "#d9d9d9", "#918edf"];

			var seriesFills = ["rgba(245,201,67,0)", "rgba(190,185,219,1)", "rgba(253,127,110,1)", "rgba(127,177,213,1)", "rgba(242,189,216,1)", "rgba(199,178,153,1)", "rgba(189,126,191,1)", "rgba(139,212,199,1)", "rgba(255,181,90,1)", "rgba(217,217,217,1)", "rgba(145,142,223,1)"];

			var seriesAppIcons = [
				{ 
					icon: "images/demo-icon-clash-of-hamsters.jpg",
					store: "ios"
				},
				{ 
					icon: "images/demo-icon-clash-of-hamsters.jpg",
					store: "ios"
				},
				{ 
					icon: "images/demo-icon-angry-hamsters.jpg",
					store: "play-store"
				},
				{ 
					icon: "images/demo-icon-five-hamsters-at-freddies.jpg",
					store: "ios"
				},
				{ 
					icon: "images/demo-icon-crossy-hamster.jpg",
					store: "play-store"
				},
				{ 
					icon: "images/demo-icon-hamster-crush.jpg",
					store: "ios"
				},
				{ 
					icon: "images/demo-icon-hamsters-vs-zombies.jpg",
					store: "ios"
				},
				{ 
					icon: "images/demo-icon-hamster-ninja.jpg",
					store: "play-store"
				},
				{ 
					icon: "images/demo-icon-8-ball-hamster.jpg",
					store: "ios"
				},
				{ 
					icon: "images/demo-icon-flappy-hamster.jpg",
					store: "ios"
				},
				{ 
					icon: "images/demo-icon-geometry-hamster.jpg",
					store: "ios"
				}
			];
			
			var usedSeriesColours = [];

			setTimeout(function() {

				for(var s = 0; s < 3; s++) {
					var mockSeries = [];
					for(var d = 0; d < 12; d++) {						
						if(chartData[s].data[d]) {
							mockSeries.push(chartData[s].data[d].value);
						} else {
							mockSeries.push(30000);
						}
					}
					mockDataRevenue.push(mockSeries);
					usedSeriesColours.push(seriesColours[s + 1]);
				}				

				revAndDownData = new Array(); 				
				revAndDownData.push(mockDataRevenue);
				revAndDownData.push(mockDataDownloads);				

				generateChart('chart-reviews', "revenueseries", mockDataRevenue, seriesColours, "area");
				$('.chart-container').addClass('is-animated');
				handleChartInteraction();

				addAppDataToSeries();
				Highcharts.Chart.prototype.setFirstVisibleSeriesToSelected();
				Highcharts.Chart.prototype.setGraphCSSClasses();
        Highcharts.Chart.prototype.resetLineStyling();
				
				$.each(Highcharts.charts, function(key, chart) {
					$.each(chart.series, function (key, series) {
						if(key > 0) {
							series.update({
								type: 'bar',
								stacking: 'stacked'
							});
						}						
					});
				});
			}, 500);
		
		});

  </script>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5513f37846b6ec2e"></script> 
</body>