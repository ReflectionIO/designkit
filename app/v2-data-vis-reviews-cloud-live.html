<!doctype html>
<html lang="en" class="no-js" ng-app="reflectionApp">
<head>
	<meta charset="utf-8" />
	<title>Reflection Data Lab, App Reviews Analysis</title>
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<link rel="stylesheet" type="text/css" href="global-layout.css" />
	<link rel="stylesheet" media="screen, projection" type="text/css" href="chart.css" />
	<link rel="stylesheet" media="screen, projection" type="text/css" href="reflection-main-v2.css" />
<script src="https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js"></script>
<link rel="stylesheet" href="js/vendor/jquery.mCustomScrollbar.css" />
<script>
  WebFont.load({
    google: {
      families: ['Open Sans:400,600,700,400italic,600italic', 'Source Sans Pro:400,600,700', 'Lato:400,700,400italic']
    }
  });
</script> <script src="js/vendor/modernizr.2.8.3.custom.min.js"></script>
	
<style>
	.chart,
	.highcharts-container,
	.chart .highcharts-root {
		overflow: visible !important;
	}
</style>	
</head>
<body>
	<!--[if (lt IE 9)]>
      <div class="window-warning">
  			<p>Uh oh... Reflection doesn't work in this browser. &nbsp; &nbsp;<a href="http://outdatedbrowser.com/en" target="_blank">Download a compatible browser</a></p>
  		</div>
  <![endif]-->
  <header id="js-component-import--global-header" class="global-header"></header>
  
	<div id="js-component-import--panel-left" class="panel-left js-panel-left js-custom-scrollbar" data-mcs-theme="minimal-dark"></div>

	<div class="l-page-container">
		<div id="main" class="l-main" role="main">
			<div class="page-lab-base grid-container page-data-vis-reviews-cloud theme-dark is-initial-state overflow-visible">

				<div class="grid__row">
					<div class="grid__row--heading-row__right">
	 					<div class="sharing-container">
	 						<div class="addthis_sharing_toolbox"></div>
	 					</div>
					</div>
				</div>
				
				<div class="page-data-vis-reviews-cloud__center-column overflow-visible">
					<div class="page-data-vis-reviews-cloud__main-content-container overflow-visible">
						<div class="filters-row js-reviews-cloud-filters-row overflow-visible">
							<div class="overflow-visible">
								<div class="page-data-vis-reviews-cloud__app-column__app-icon-container">
									<img 
										src="images/data-vis-reviews-cloud-app-icon-placeholder.jpg"
										alt="App Name"
										class="js-app-icon" />
								</div>
								<div class="page-data-vis-reviews-cloud__app-column__search-container">
									<div class="secondary-filter secondary-filter--medium form-field--search">
										<input type="text" placeholder="Find an App" name="appId" id="appId" class="js-app-search-input" />
										<label for="findapp" class="ref-icon-after--search"><span>Search</span></label>
										<a href="#" class="clear-search ref-icon-after--close js-clear-search">Clear</a>
										<ul class="form-field--select__dropdown js-search-results-drop-down" style="min-width: 250px; display: none; left: -2px; top: 42px;">
											<div class="app-search-loading-indicator js-app-search-loading-indicator" style="display: none;">
												<span>Searching...</span>
												<img src="images/loadingSpinner.gif" alt="Loading" class="search-loading-indicator" /></div>
										</ul>
									</div>
									<h3 class="page-data-vis-reviews-cloud__developer-name">
										By <span class="js-developer-name">Developer Name</span>
									</h3>
								</div>
								
								<div class="secondary-filter secondary-filter--medium form-field--select js-secondary-filter js-dropdown-country">
									<select class="js-select-box">
										<option value="GB" selected="selected" class="icon-flag-sm icon-flag--GB">United Kingdom</option>
										<option value="US" class="icon-flag-sm icon-flag--US">USA</option>
										<option value="AU" class="icon-flag-sm icon-flag--AU">Australia</option>
										<option value="BR" class="icon-flag-sm icon-flag--BR">Brazil</option>
										<option value="CA" class="icon-flag-sm icon-flag--CA">Canada</option>
										<option value="DK" class="icon-flag-sm icon-flag--DK">Denmark</option>
										<option value="FR" class="icon-flag-sm icon-flag--FR">France</option>
										<option value="DE" class="icon-flag-sm icon-flag--DE">Germany</option>
										<option value="ID" class="icon-flag-sm icon-flag--ID">Indonesia</option>
										<option value="IE" class="icon-flag-sm icon-flag--IE">Ireland</option>
										<option value="IT" class="icon-flag-sm icon-flag--IT">Italy</option>
										<option value="MY" class="icon-flag-sm icon-flag--MY">Malaysia</option>
										<option value="MX" class="icon-flag-sm icon-flag--MX">Mexico</option>
										<option value="NZ" class="icon-flag-sm icon-flag--NZ">New Zealand</option>
										<option value="NO" class="icon-flag-sm icon-flag--NO">Norway</option>
										<option value="PT" class="icon-flag-sm icon-flag--PT">Portugal</option>
										<option value="RU" class="icon-flag-sm icon-flag--RU">Russia</option>
										<option value="SA" class="icon-flag-sm icon-flag--SA">Saudi Arabia</option>
										<option value="SG" class="icon-flag-sm icon-flag--SG">Singapore</option>
										<option value="ES" class="icon-flag-sm icon-flag--ES">Spain</option>
										<option value="SE" class="icon-flag-sm icon-flag--SE">Sweden</option>
										<option value="TR" class="icon-flag-sm icon-flag--TR">Turkey</option>
										<option value="AE" class="icon-flag-sm icon-flag--AE">United Arab Emirates</option>
									</select>
								</div>
							</div>
														
						</div>
					</div>
				</div>
				
				<div class="chart-heading">
					<h2>Average Rating &amp; Reviews Split</h2>
					<h3>Latest <span class="js-no-of-reviews"></span> Reviews</h3>
					<div class="chart-heading__row-two">
						<h4>From Latest <span class="js-no-of-reviews"></span>  Reviews</h4>
						<div class="overall-reviews-container js-overall-reviews-container">
							<span class="overall-reviews-container__label">Average</span>
							<div class='ratings-container'><div class='ratings-full'></div></div><span class='reviews-timeline-tooltip__average-value'></span>
						</div>
					</div>
				</div>
				
				<section class="chart-container">
					<div class="chart" id="chart-reviews" style="overflow: visible;"></div>
					<div class="start-instruction">
						<img src="images/onboarding-find-an-app.png" alt="Find an app to get started" />
					</div>
					<div class="chart__loading">
						<div class="hamster-wheel">
							<img src="images/hamster-wheel-dark.png" alt="hamster wheel">
						</div>
						<div class="animation-hamster animation-hamster--dark"></div>
					</div>
				</section>
				
				<div class="is-initial-state">
				<div class="page-data-vis-reviews-cloud__center-column">
					<div class="page-data-vis-reviews-cloud__main-content-container">
						<div>
							<div class="reviews-cloud-heading">
								<h3>Commonly Appearing Words in Latest <span class="js-no-of-reviews"></span> Reviews</h3>
								<div class="toggle-container filter-toggle filter-toggle--with-text filter-toggle--small">
									<div class="toggle js-toggle">
										<input id="toggle--show-all" name="radiomedium" data-cloudtotoggle="tag-cloud--all" checked="" type="radio">
										<label for="toggle--show-all">
											All Reviews
										</label>
									</div>
									<div class="toggle js-toggle">
										<input id="toggle--show-five" name="radiomedium" data-cloudtotoggle="tag-cloud--positive" type="radio">
										<label for="toggle--show-five">
											4 - 5 Stars
										</label>
									</div>
									<div class="toggle js-toggle">
										<input id="toggle--show-three" name="radiomedium" data-cloudtotoggle="tag-cloud--average" type="radio">
										<label for="toggle--show-three">
											3 Stars
										</label>
									</div>
									<div class="toggle js-toggle">
										<input id="toggle--show-one" name="radiomedium" data-cloudtotoggle="tag-cloud--negative" type="radio">
										<label for="toggle--show-one">
											1 - 2 Stars
										</label>
									</div>
								</div>
							</div>
							<aside class="page-data-vis-reviews-cloud__app-column">

								<div class="page-data-vis-reviews-cloud__reviews-widget">
									<h4>Times <span class="js-keyword-hover">'Keyword'</span> Appears in Recent Reviews</h4>
									<h5>Total <span class="selected-country-text js-selected-country-text"></span>: <span class="total-reviews-count js-all-stars">-</span></h5>
									<ul>
										<li>
											<span class="number-of-stars-label ref-icon-after--star">5</span>
											<span class="rating-number js-five-stars"></span>
											<div class="rating-percentage-container"><div class="rating-percentage"></div></div>
											<span class="rating-percentage-text js-five-stars-percent">%</span>
										</li>
										<li>
											<span class="number-of-stars-label ref-icon-after--star">4</span>
											<span class="rating-number js-four-stars"></span>
											<div class="rating-percentage-container"><div class="rating-percentage"></div></div>
											<span class="rating-percentage-text js-four-stars-percent">%</span>
										</li>
										<li>
											<span class="number-of-stars-label ref-icon-after--star">3</span>
											<span class="rating-number js-three-stars"></span>
											<div class="rating-percentage-container"><div class="rating-percentage"></div></div>
											<span class="rating-percentage-text js-three-stars-percent">%</span>
										</li>
										<li>
											<span class="number-of-stars-label ref-icon-after--star">2</span>
											<span class="rating-number js-two-stars"></span>
											<div class="rating-percentage-container"><div class="rating-percentage"></div></div>
											<span class="rating-percentage-text js-two-stars-percent">%</span>
										</li>
										<li>
											<span class="number-of-stars-label ref-icon-after--star">1</span>
											<span class="rating-number js-one-stars"></span>
											<div class="rating-percentage-container"><div class="rating-percentage"></div></div>
											<span class="rating-percentage-text js-one-stars-percent">%</span>
										</li>
									</ul>
								</div>
								
								<div class="cloud-key-instruction-container">
									<h2 class="cloud-key-instruction ref-icon-before--info-no-fill">Click a word to read reviews containing it.</h2>
									
									<h2 class="cloud-key-instruction ref-icon-before--info-no-fill">The bigger a word in the cloud, the more it has been used. </h2>
									
									<h2 class="cloud-key-instruction ref-icon-before--info-no-fill"><span class="positive-colour">Green</span> = Positive, <span class="negative-colour">Red</span> = Negative, <span class="neutral-colour">Grey</span> = Neutral</h2>
								</div>
							</aside>

							<div class="page-data-vis-reviews-cloud__cloud-section">
								<div class="tag-cloud-container" style="margin-bottom: 6rem;">
									
									<div class="chart__loading">
										<div class="hamster-wheel">
											<img src="images/hamster-wheel-dark.png" alt="hamster wheel">
										</div>
										<div class="animation-hamster animation-hamster--dark"></div>
									</div>
									
									<div class="chart__no-data">
										<div class="animation-hamster-no-data-dark"></div>
    								<div>
											<h2>No Reviews Found</h2>
											<p>Sorry, we couldn't retrieve any reviews for the chosen app and country. Try changing the app name or the country above.</p>
										</div>
									</div>
									
									<ul class="tag-cloud tag-cloud--all"></ul>
									<ul class="tag-cloud tag-cloud--positive"></ul>
									<ul class="tag-cloud tag-cloud--average"></ul>
									<ul class="tag-cloud tag-cloud--negative"></ul>
									<div class="reviews-content-container js-reviews-content-container">
										<h2 class="heading-style--heading-five">Latest Reviews Featuring <span class="reviews-content-container__keyword js-keyword">...</span></h2>
										<div class="ratings-list js-custom-scrollbar" data-mcs-theme="minimal-dark">
											<ul class="js-reviews-content">
												<li>
													<h2 class="reviews-content__title">Click a term above to see the reviews it appears in</h2>
												</li>
											</ul>
										</div>
									</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			</div>
			</div>
	</div>

	<div class="grid-container global-footer-dark global-footer-dark--lab" id="js-component-import--global-footer"></div>

	<div id="js-component-import--account-container" class="panel-right-container js-account-container"></div>
	<div id="js-component-import--search-container" class="panel-right-container js-search-container"></div>

 	<script src="js/vendor/jquery-1.11.1.min.js"></script>
 	<script src="js/vendor/handlebars-v2.0.0.js"></script> <!-- static templates only -->
 	<script src="js-v2/templates/templates.js"></script> <!-- static templates only -->
 	<script src="js/vendor/modernizr.2.8.3.custom.min.js"></script>

	<script src="js/vendor/jquery.mCustomScrollbar.concat.min.js"></script>

	<div id="js-appendScriptsContainer"></div>

	<script src="js-v2/app-include-templates.js"></script> <!-- static templates only -->
  <script src="js-v2/application.js"></script>
		
	<script src="https://www.reflection.io/js/highcharts.js"></script>
  
	<script>
		
		var rawReviews = {};

		if (!String.prototype.splice) {
		    String.prototype.splice = function(start, delCount, newSubStr) {
		        return this.slice(0, start) + newSubStr + this.slice(start + Math.abs(delCount));
		    };
		}

		function shuffle(array) {
		  var currentIndex = array.length, temporaryValue, randomIndex;

		  // While there remain elements to shuffle...
		  while (0 !== currentIndex) {

		    // Pick a remaining element...
		    randomIndex = Math.floor(Math.random() * currentIndex);
		    currentIndex -= 1;

		    // And swap it with the current element.
		    temporaryValue = array[currentIndex];
		    array[currentIndex] = array[randomIndex];
		    array[randomIndex] = temporaryValue;
		  }

		  return array;
		}

		function populateReviewsContent(term) {
			// find reviews that contain the term
			$('.js-reviews-content-container').show();
			
			var currentCloud = $('.js-reviews-cloud-filters-row .filter-toggle input:checked').attr("data-cloudtotoggle");
			var filterByRating = null;
			var filterByRatingMin = null;
			var filterByRatingMax = null;
			if(currentCloud == "tag-cloud--positive") {
				filterByRating = true;
				filterByRatingMin = 4;
				filterByRatingMax = 5;
			} else if(currentCloud == "tag-cloud--average") {
				filterByRating = true;
				filterByRatingMin = 3;
				filterByRatingMax = 3;
			} else if(currentCloud == "tag-cloud--negative") {
				filterByRating = true;
				filterByRatingMin = 0;
				filterByRatingMax = 2;
			}
			
			var reviewsToOutput = [];
			var counter = 0;
			for(var i = 0; i < rawReviews.length; i++) {
				if(rawReviews[i].content.toLowerCase().indexOf(term.toLowerCase()) > -1) {
					if(filterByRating == null) {
						reviewsToOutput.push(rawReviews[i]);
						counter++;
					} else {
						if(rawReviews[i].rating >= filterByRatingMin && rawReviews[i].rating <= filterByRatingMax) {
							reviewsToOutput.push(rawReviews[i]);
							counter++;
						}
					}
				}
			}
			
			$('.js-reviews-content').empty();
			$('.js-keyword').text("'" + term + "'");

			for(var i = 0; i < reviewsToOutput.length; i++) {

				var contentString = reviewsToOutput[i].content;
				var indexOfString = reviewsToOutput[i].content.toLowerCase().indexOf(term);
				var wordLength = term.length;
				var formattedContent = contentString.splice(indexOfString + wordLength, 0, "</strong>");
				formattedContent = formattedContent.splice(indexOfString, 0, "<strong>");

				var ratingsContainer = $("<div>").addClass("ratings-container").append($("<div>").addClass("ratings-full").css("width", ((reviewsToOutput[i].rating / 5) * 100) + "%"));
				var reviewTitle = $("<h2>").addClass("reviews-content__title").html(reviewsToOutput[i].title);
				var reviewDate = new Date(reviewsToOutput[i].date);
				var formattedReviewDate = reviewDate.getDate() + "/" + (reviewDate.getMonth()+1) + "/" + reviewDate.getFullYear();
				var reviewDate = $("<span>").addClass("reviews-content__date").text(formattedReviewDate);
				var reviewContent = $("<p>").html(formattedContent);

				$('.js-reviews-content').append($("<li>").append(ratingsContainer)
																									.append(reviewTitle)
																									.append(reviewDate)
																									.append(reviewContent)
																				);
			}
		}
		
		function clearPreviousTimelineChart() {
			if(window.reviewsCloudTimelineChart && window.reviewsCloudTimelineChart.series) {
				while(window.reviewsCloudTimelineChart.series.length > 0) {
    			window.reviewsCloudTimelineChart.series[0].remove(true);
				}
			}
		}
		
		function updateChartSeriesTypes() {
			if(window.reviewsCloudTimelineChart != undefined && window.reviewsCloudTimelineChart.series && window.reviewsCloudTimelineChart.series.length) {
				$.each(window.reviewsCloudTimelineChart.series, function (key, series) {
					if(key > 0) {
						series.update({
							type: 'bar',
							stacking: 'stacked',
						});
					} else {
						series.update({
							zIndex: 10
						});
					}
				});	
			}
		}
		
		function generateChart(containerId, dataType, seriesData, seriesColour, chartType) {
			
			var seriesColour,
					seriesArray = [],
					monthNames = [
						"Jan", "Feb", "Mar",
						"Apr", "May", "Jun", "Jul",
						"Aug", "Sep", "Oct",
						"Nov", "Dec"
					],
					dayNames = ["Su", "Mo", "Tu", "We", "Th", "Fr", "Sa"];
			
			var chartWidth = $(".chart-container").width();
			
			for(var a = 0; a < seriesData.length; a++) {

				seriesArray.push({
					yAxis: (a == 0) ? 1 : 0,
					name: "series-" + a,
					id : "series-" + a,
					type: (a == 0) ? 'area' : 'area',
					stacking: null,
					color: seriesColour[a],
					data: seriesData[a],
					borderRadiusTopLeft: 3,
					borderRadiusTopRight: 3,
					lineColor: seriesColour[a],
					lineWidth: 3,
					lineWidthPlus: 0,
					fillOpacity: 0,
					fillColor: null,
					marker: {
						enabled: false,
						states: {
							hover: {
								enabled: true,
								lineWidth: 0,
								lineWidthPlus: 0,
								radius: 4,
								radiusPlus: 0,
							}
						}
					}
				});
			}

			// Generate Demo Chart, using the properties set above
			if(!window.reviewsCloudTimelineChart) {
				window.reviewsCloudTimelineChart = new Highcharts.Chart({
					chart: {
						renderTo: containerId,
						marginLeft: 0,
						marginRight: 0,
						marginBottom: 0,
						marginTop: 0,
						spacing: [0,0,0,0],
						height: 250,
						backgroundColor: '#343438',
						plotBackgroundColor: '#343438',
						type: chartType,
						animation: false,
						style: {
							fontFamily: 'Source Sans Pro'
						},
						events: {
						}
					},
					legend: {
						enabled: false
					},
					title: {
							text: ''
					},
					yAxis: [{
						lineWidth: 2,
						offset: 0,
						lineColor: '#222222',
					}, {
						lineWidth: 2,
						gridLineWidth: 1,
						gridLineColor: '#222222',
						opposite: true,
						offset: 0,
						lineColor: '#222222',
					}],
					xAxis: {
						lineColor: '#222222',
						startOnTick: true,
						endOnTick: true,
						showFirstLabel: true,
						maxPadding: 0,
						minPadding: 0,
						type: 'datetime',
						dateTimeLabelFormats: {
							day: '%e %b',
							week: '%e %b',
							month: '%Y-%m',
							year: '%Y'
						},
						tickmarkPlacement: 'on',
						tickLength: 0,
						labels: {
							align: 'center',
							x: 0,
							y: 22,
							step: 1,
							style: {
								color: '#81879D',
								fontSize: "12px"
							}
						},
					},
					plotOptions: {
						area: {
							trackByArea: true,
							tooltip: {
								followPointer: true
							},
							states: {
								hover: {
									halo: {
										size: 0
									},
									lineWidthPlus: 0
								}
							},
							marker: {
								symbol: "circle"
							}		
						},
						bar: {
							borderColor: "#343438",
							borderWidth: 2,
							groupPadding: 0.08,
							pointPadding: 0,
							states: {
								hover : {
									brightness: 0.1
								}
							}
						},
						series: {
							pointStart: new Date(seriesData[0][0][0]).addHours(-12),
							animation: false
						},
					},
					series: seriesArray,
					tooltip: {
						useHTML: true,
						shared: true,
						formatter: function() {	          	
							var instance = this;
							var s = "";
							
							var thisDate = new Date(instance.points[0].point.x);
							var thisDateFormatted = dayNames[thisDate.getDay()] + " " + thisDate.getDate() + " " + monthNames[thisDate.getMonth()] + " " + thisDate.getFullYear();
							
							var totalReviewsForPoint = instance.points[1].y + instance.points[2].y;
							var averageRatingAsPerc = instance.points[0].y.toFixed(1) / 5 * 100;
							var percOfPos = instance.points[1].y / totalReviewsForPoint * 100;
							var percOfNeg = instance.points[2].y / totalReviewsForPoint * 100;
							
							s = "<div class='reviews-timeline-tooltip'>";
							
							s += "<span class='reviews-timeline-tooltip__date'>" + thisDateFormatted + "</span>";
							
							s += "<span class='reviews-timeline-tooltip__average-container'>Average <div class='ratings-container'><div class='ratings-full' style='width:" + averageRatingAsPerc + "%'></div></div><span class='reviews-timeline-tooltip__average-value'>" + instance.points[0].y.toFixed(1) + "</span></span>";
							
							s += "<span class='reviews-timeline-tooltip__total-reviews-container'><span class='reviews-timeline-tooltip__total-reviews-label'>Reviews</span><span class='reviews-timeline-tooltip__total-reviews-value'>" + totalReviewsForPoint + "</span></span>";
							
							s += "<span class='reviews-timeline-tooltip__total-reviews-positive'><span class='reviews-timeline-tooltip__total-reviews-label'>4 - 5 Stars</span> <span class='reviews-timeline-tooltip__total-reviews-positive-value'>" + instance.points[1].y + "</span><span class='reviews-timeline-tooltip__total-reviews-positive-percent'>" + percOfPos.toFixed(1) + "%</span></span>";
							
							s += "<span class='reviews-timeline-tooltip__total-reviews-negative'><span class='reviews-timeline-tooltip__total-reviews-label'>0 - 3 Stars</span><span class='reviews-timeline-tooltip__total-reviews-negative-value'>" + instance.points[2].y + "</span><span class='reviews-timeline-tooltip__total-reviews-negative-percent'>" + percOfNeg.toFixed(1) + "%</span></span>";
							
							s += "</div>"
							return s;
						},
						backgroundColor: 'transparent',
						borderWidth: 0,
						borderColor: '#dae3ed',
						crosshairs: [{
							width: 1,
							color: '#9ea7c4'
						}],
						shadow: {
							color: 'rgba(0,0,0,0.24)',
							width: 0,
							offsetX: 1,
							offsetY: 1
						},
						snap: 25
					}
				});
			} else {
				clearPreviousTimelineChart();
				$.each(seriesArray, function (key, series) {
					series.pointStart = new Date(series.data[0][0]).addHours(-12);
					window.reviewsCloudTimelineChart.addSeries(series, false);
				});
				
				window.reviewsCloudTimelineChart.redraw();
			}
			
			updateChartSeriesTypes();
		} // end generateChart()
		
		function generateReviewsCloud() {
				
			$('.tag-cloud--all').empty();			
			$('.tag-cloud--positive').empty();
			$('.tag-cloud--average').empty();
			$('.tag-cloud--negative').empty();
			
			$('.is-initial-state').removeClass("is-initial-state")
			$('body').addClass("is-loading-data");
			$('body').removeClass("is-no-data");
			var myHeaders = new Headers();
			var myInit = { method: 'GET',
					 headers: myHeaders,
					 mode: 'cors',
					 cache: 'default',
			};

			var appId = $('.js-app-search-input').attr("data-appid");
			var countryCode = $('.js-dropdown-country .js-dropdown-trigger').attr("data-value");

			fetch('https://stats.reflection.io/microservices/wordcloud2?itemid=' + appId + '&country=' + countryCode, myInit).then(function(response) {
				return response.json().then(function(json) {
		console.log(json)			
					if(json.reviewsCloudData) {
						var reviewsCloud = {
							data: json.reviewsCloudData
						};

						rawReviews = json.reviewsRaw;

						if(json.appIcon) {
							$('.js-app-icon').attr("src", json.appIcon);
						}

						$('body').removeClass("is-loading-data");
						$('body').removeClass("is-no-data");
						handleData(reviewsCloud.data);
						
						// generate the timeline highchart
					} else {
						// show cannot find reviews
						$('body').removeClass("is-loading-data");
						$('body').addClass("is-no-data");
					}
					
					// format the data for highcharts
					let chartDataFormatted = [];

					var seriesColours = ["#54BEE5", "#1BC79F", "#FF496A"];

					var averageRatingsFromJSON = JSON.parse(json.timeline.average_rating);
					var posRatingsFromJSON = JSON.parse(json.timeline["n_positive"]);
					var negRatingsFromJSON = JSON.parse(json.timeline["n_negative"]);
					var averageRatingsFormatted = [],
							posRatingsFormatted = [],
							negRatingsFormatted = [];
					
					averageRatingsFromJSON.forEach(function(obj){
						var newArray = [];
						newArray.push(obj.date);
						if(obj.average_rating == null) {
							obj.average_rating = 0;
						}
						newArray.push(obj.average_rating);
						averageRatingsFormatted.push(newArray);
					});
					
					posRatingsFromJSON.forEach(function(obj){
						var newArrayPos = [];
						newArrayPos.push(obj.date);
						if(obj.n_pos == null) {
							obj.n_pos = 0;
						}
						newArrayPos.push(obj.n_pos);
						posRatingsFormatted.push(newArrayPos);
					});
					
					negRatingsFromJSON.forEach(function(obj){
						var newArrayNeg = [];
						newArrayNeg.push(obj.date);
						if(obj.n_neg == null) {
							obj.n_neg = 0;
						}
						newArrayNeg.push(obj.n_neg);
						negRatingsFormatted.push(newArrayNeg);
					});
					
					var mockDataRevenue = [];
					mockDataRevenue.push(averageRatingsFormatted, posRatingsFormatted, negRatingsFormatted);
					console.log("mockDataRevenue");
					console.log(mockDataRevenue);
					generateChart('chart-reviews', "revenueseries", mockDataRevenue, seriesColours, "area");
					
					if(json["n_reviews"]) {
						$('.js-no-of-reviews').text(json["n_reviews"]).show();
					} else {
						$('.js-no-of-reviews').hide();
					}
					
					if(json["avg_review_rating"]) {
						var ratingAsPercent = json["avg_review_rating"] / 5 * 100;
						$('.js-overall-reviews-container .ratings-full').css("width", ratingAsPercent + "%");
						$('.js-overall-reviews-container .reviews-timeline-tooltip__average-value').text(json["avg_review_rating"].toFixed(1));
					} else {
						$('.js-overall-reviews-container .ratings-full').css("width", 0);
					}
				});
			});
		};
		
		var FilterDropDown = function($domElement) {

			var $thisSelectBox = $domElement,
					$dropDownContainer = $("<ul>").addClass("form-field--select__dropdown"),
					$currentValue = $("<span>").addClass("form-field--select__box ref-icon-after--angle-down js-dropdown-trigger").attr("data-value", "GB");

			$thisSelectBox.find('option').each(function(){
				
				var $thisOption = $(this),
						selectedClass = "",
						cssClass = $thisOption.attr("class");

						if($($thisOption).is(":selected")) {
							if($thisOption.val() != "") {

								selectedClass = "is-selected";
								var countryFlag = $("<span>").addClass(cssClass);
								var triggerText = $("<b>").text($thisOption.text());
								$currentValue.append(countryFlag);
								$currentValue.append(triggerText);
							}
						}

				if($thisOption.val() != "") {

					var accessClass = "";
					if($thisOption.data("access")) {
						accessClass = "ref-icon-after--key";
					}

					var $newListItem = $("<li>");
					$dropDownContainer.append($newListItem
																				.addClass("js-dropdown-option")
																				.addClass(selectedClass)
																				.addClass(accessClass)
																				.attr('data-icon-flag', cssClass)
																				.attr('data-value', $thisOption.attr('value'))
																				.on("click", function() {
																					var $this = $(this);
																					$('.js-dropdown-trigger').attr("data-value", $(this).attr("data-value"));	
																					if($('.js-app-search-input').val()) {
																						generateReviewsCloud();
																					}
																					closeAllFilters();

																					$('.js-dropdown-option.is-selected').removeClass("is-selected");
																					$this.addClass("is-selected");
																					$('.js-dropdown-trigger').empty();
																					var countryIcon = $("<span>").addClass($this.attr("data-icon-flag"));
																					$('.js-dropdown-trigger').append(countryIcon);
																					var triggerText = $("<b>").text($thisOption.text());
																					$('.js-dropdown-trigger').append(triggerText);
																				})
																				.append($("<span>").addClass(cssClass))
																				.append($("<span>").text($thisOption.text()))
																	);
				}
			});

			$currentValue.on("click", function(){
				if(!$thisSelectBox.attr("disabled")) {
					var $parentDiv = $thisSelectBox.parent("div");
					if($parentDiv.hasClass("is-open")) {
						$dropDownContainer.toggle();	
						$parentDiv.toggleClass("is-open");
					} else {
						setTimeout(function(){
							if(!$parentDiv.hasClass("is-open")) {
								closeAllFilters();
							}
							var parentWidth = $parentDiv.width();
							var parentHeight = $parentDiv.height();
							$dropDownContainer.css({"min-width": parentWidth + "px"});
							$dropDownContainer.toggle();	
							$parentDiv.toggleClass("is-open");
						}, 50); // allow time for instance.closeAllFilters() to close other filters first
					}
				}
			});

			if($currentValue.text() == "") {
				$thisSelectBox.parent("div").addClass("nothing-selected");
			}

			$thisSelectBox.parent("div").append($currentValue)
																	.append($dropDownContainer);
		}

		function closeAllFilters() {
			$('.js-secondary-filter.is-open .form-field--select__dropdown').hide();
			$('.js-secondary-filter.is-open').removeClass("is-open");
		}

		function scrollToReviews() {
			var scrollTo = $('.js-reviews-content-container').offset().top;
			$("html, body").animate({scrollTop: scrollTo - 100}, '500');
		}

		function handleData(cloudData) {

			$('.tag-cloud--all').empty();			
			$('.tag-cloud--positive').empty();
			$('.tag-cloud--average').empty();
			$('.tag-cloud--negative').empty();
			$('.js-reviews-content').empty().append($('<li><h2 class="reviews-content__title">Click a term above to see the reviews it appears in</h2></li>'));
		
			var minFontSize = 1,
					maxFontSize = 7;

			var topResultsArray = [];

			for(var t = 0; t < 100 && t < cloudData.length; t++) {
				topResultsArray.push(cloudData[t]);
			}

			// shuffle the sorted results
			shuffle(topResultsArray);
			var highestFrequency = cloudData[0].freq.freq_overall;
			var positiveReviewTotals = [],
				averageReviewTotals = [],
				negativeReviewTotals = [];

			for(var t = 0; t < topResultsArray.length; t++) {
				var fontSize = topResultsArray[t].freq.freq_overall / highestFrequency * maxFontSize + 0.5;
				var total = topResultsArray[t].freq.freq_overall;
				var cssClass = "negative-average";
				if(topResultsArray[t].freq.average_rating > 2.5 && topResultsArray[t].freq.average_rating < 3.5) {
					cssClass = "average-average";
				} else if(topResultsArray[t].freq.average_rating > 3.5) {
					cssClass = "positive-average";
				}
				$('.tag-cloud--all').append(
					$("<li>").addClass(cssClass)
										.text(topResultsArray[t].term)
										.data("font-size", fontSize + "rem")
										.data("index", t)
										.data("total", total)
										.data("average", topResultsArray[t].freq.average_rating)
										.attr("data-term", topResultsArray[t].term)
										.on("mouseenter", function(){
											var thisTerm = $(this).text();
											$('.js-keyword-hover').text("'" + thisTerm + "'");

											var thisIndex = $(this).data("index");
											var totalFromTag = $(this).data("total");
											
											var percFiveStars = Math.round((topResultsArray[thisIndex].freq.freq_5stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
											$('.js-five-stars').text(topResultsArray[thisIndex].freq.freq_5stars);
											$('.js-five-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percFiveStars + "%");
											$('.js-five-stars-percent').text(percFiveStars + "%");

											var percFourStars = Math.round((topResultsArray[thisIndex].freq.freq_4stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
											$('.js-four-stars').text(topResultsArray[thisIndex].freq.freq_4stars);
											$('.js-four-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percFourStars + "%");
											$('.js-four-stars-percent').text(percFourStars + "%");
											
											var percThreeStars = Math.round((topResultsArray[thisIndex].freq.freq_3stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
											$('.js-three-stars').text(topResultsArray[thisIndex].freq.freq_3stars);
											$('.js-three-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percThreeStars + "%");
											$('.js-three-stars-percent').text(percThreeStars + "%");
											
											var percTwoStars = Math.round((topResultsArray[thisIndex].freq.freq_2stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
											$('.js-two-stars').text(topResultsArray[thisIndex].freq.freq_2stars);
											$('.js-two-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percTwoStars + "%");
											$('.js-two-stars-percent').text(percTwoStars + "%");
											
											var percOneStars = Math.round((topResultsArray[thisIndex].freq.freq_1stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
											$('.js-one-stars').text(topResultsArray[thisIndex].freq.freq_1stars);
											$('.js-one-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percOneStars + "%");
											$('.js-one-stars-percent').text(percOneStars + "%");
											
											$('.js-all-stars').text(topResultsArray[thisIndex].freq.freq_overall);
										})
										.on("click", function(){											
											populateReviewsContent($(this).attr("data-term"));
											scrollToReviews();
										})
				);

				positiveReviewTotals.push(topResultsArray[t].freq.freq_5stars + topResultsArray[t].freq.freq_4stars);
				averageReviewTotals.push(topResultsArray[t].freq.freq_3stars);
				negativeReviewTotals.push(topResultsArray[t].freq.freq_2stars + topResultsArray[t].freq.freq_1stars);
			}

			positiveReviewTotals.sort(function(a, b){return b-a});
			averageReviewTotals.sort(function(a, b){return b-a});
			negativeReviewTotals.sort(function(a, b){return b-a});

			var highestPositiveReviewTotal = positiveReviewTotals[0];
			for(var t = 0; t < topResultsArray.length; t++) {
				if(topResultsArray[t].freq.freq_5stars > 0 || topResultsArray[t].freq.freq_4stars > 0) { // create cloud for positive reviews
						var fontSize = (topResultsArray[t].freq.freq_5stars + topResultsArray[t].freq.freq_4stars) / highestPositiveReviewTotal * maxFontSize + 0.5;
						var total = topResultsArray[t].freq.freq_overall;
						$('.tag-cloud--positive').append(
							$("<li>").text(topResultsArray[t].term)
												.data("font-size", fontSize + "rem")
												.data("index", t)
												.data("total", total)
												.attr("data-term", topResultsArray[t].term)
												.on("mouseenter", function(){
													var thisTerm = $(this).text();
													$('.js-keyword-hover').text("'" + thisTerm + "'");

													var thisIndex = $(this).data("index");
													var totalFromTag = $(this).data("total");

													var percFiveStars = Math.round((topResultsArray[thisIndex].freq.freq_5stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
													$('.js-five-stars').text(topResultsArray[thisIndex].freq.freq_5stars);
													$('.js-five-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percFiveStars + "%");
													$('.js-five-stars-percent').text(percFiveStars + "%");

													var percFourStars = Math.round((topResultsArray[thisIndex].freq.freq_4stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
													$('.js-four-stars').text(topResultsArray[thisIndex].freq.freq_4stars);
													$('.js-four-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percFourStars + "%");
													$('.js-four-stars-percent').text(percFourStars + "%");
													
													var percThreeStars = Math.round((topResultsArray[thisIndex].freq.freq_3stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
													$('.js-three-stars').text(topResultsArray[thisIndex].freq.freq_3stars);
													$('.js-three-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percThreeStars + "%");
													$('.js-three-stars-percent').text(percThreeStars + "%");
													
													var percTwoStars = Math.round((topResultsArray[thisIndex].freq.freq_2stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
													$('.js-two-stars').text(topResultsArray[thisIndex].freq.freq_2stars);
													$('.js-two-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percTwoStars + "%");
													$('.js-two-stars-percent').text(percTwoStars + "%");
													
													var percOneStars = Math.round((topResultsArray[thisIndex].freq.freq_1stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
													$('.js-one-stars').text(topResultsArray[thisIndex].freq.freq_1stars);
													$('.js-one-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percOneStars + "%");
													$('.js-one-stars-percent').text(percOneStars + "%");
													
													$('.js-all-stars').text(topResultsArray[thisIndex].freq.freq_overall);

												})
												.on("click", function(){
													populateReviewsContent($(this).attr("data-term"));
													scrollToReviews();
												})
						);
				}
			}

			var highestAverageReviewTotal = averageReviewTotals[0];
			for(var t = 0; t < topResultsArray.length; t++) {
				if(topResultsArray[t].freq.freq_3stars > 0) { // create cloud for average reviews
						var fontSize = (topResultsArray[t].freq.freq_3stars) / highestAverageReviewTotal * maxFontSize + 0.5;
						var total = topResultsArray[t].freq.freq_overall;
						$('.tag-cloud--average').append(
							$("<li>").text(topResultsArray[t].term)
												.data("font-size", fontSize + "rem")
												.data("index", t)
												.data("total", total)
												.attr("data-term", topResultsArray[t].term)
												.on("mouseenter", function(){

													var thisTerm = $(this).text();
													$('.js-keyword-hover').text("'" + thisTerm + "'");

													var thisIndex = $(this).data("index");
													var totalFromTag = $(this).data("total");

													var percFiveStars = Math.round((topResultsArray[thisIndex].freq.freq_5stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
													$('.js-five-stars').text(topResultsArray[thisIndex].freq.freq_5stars);
													$('.js-five-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percFiveStars + "%");
													$('.js-five-stars-percent').text(percFiveStars + "%");

													var percFourStars = Math.round((topResultsArray[thisIndex].freq.freq_4stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
													$('.js-four-stars').text(topResultsArray[thisIndex].freq.freq_4stars);
													$('.js-four-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percFourStars + "%");
													$('.js-four-stars-percent').text(percFourStars + "%");
													
													var percThreeStars = Math.round((topResultsArray[thisIndex].freq.freq_3stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
													$('.js-three-stars').text(topResultsArray[thisIndex].freq.freq_3stars);
													$('.js-three-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percThreeStars + "%");
													$('.js-three-stars-percent').text(percThreeStars + "%");
													
													var percTwoStars = Math.round((topResultsArray[thisIndex].freq.freq_2stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
													$('.js-two-stars').text(topResultsArray[thisIndex].freq.freq_2stars);
													$('.js-two-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percTwoStars + "%");
													$('.js-two-stars-percent').text(percTwoStars + "%");
													
													var percOneStars = Math.round((topResultsArray[thisIndex].freq.freq_1stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
													$('.js-one-stars').text(topResultsArray[thisIndex].freq.freq_1stars);
													$('.js-one-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percOneStars + "%");
													$('.js-one-stars-percent').text(percOneStars + "%");
													
													$('.js-all-stars').text(topResultsArray[thisIndex].freq.freq_overall);

												})
												.on("click", function(){
													populateReviewsContent($(this).attr("data-term"));
													scrollToReviews();
												})
						);
				}
			}

			var highestNegativeReviewTotal = negativeReviewTotals[0];
			for(var t = 0; t < topResultsArray.length; t++) {
				if(topResultsArray[t].freq.freq_2stars > 0 || topResultsArray[t].freq.freq_1stars > 0) { // create cloud for negative reviews
						var fontSize = (topResultsArray[t].freq.freq_2stars + topResultsArray[t].freq.freq_1stars) / highestNegativeReviewTotal * maxFontSize + 0.5;
						var total = topResultsArray[t].freq.freq_overall;
						$('.tag-cloud--negative').append(
							$("<li>").text(topResultsArray[t].term)
												.data("font-size", fontSize + "rem")
												.data("index", t)
												.data("total", total)
												.attr("data-term", topResultsArray[t].term)
												.on("mouseenter", function(){

													var thisTerm = $(this).text();
													$('.js-keyword-hover').text("'" + thisTerm + "'");

													var thisIndex = $(this).data("index");
													var totalFromTag = $(this).data("total");

													var percFiveStars = Math.round((topResultsArray[thisIndex].freq.freq_5stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
													$('.js-five-stars').text(topResultsArray[thisIndex].freq.freq_5stars);
													$('.js-five-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percFiveStars + "%");
													$('.js-five-stars-percent').text(percFiveStars + "%");

													var percFourStars = Math.round((topResultsArray[thisIndex].freq.freq_4stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
													$('.js-four-stars').text(topResultsArray[thisIndex].freq.freq_4stars);
													$('.js-four-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percFourStars + "%");
													$('.js-four-stars-percent').text(percFourStars + "%");
													
													var percThreeStars = Math.round((topResultsArray[thisIndex].freq.freq_3stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
													$('.js-three-stars').text(topResultsArray[thisIndex].freq.freq_3stars);
													$('.js-three-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percThreeStars + "%");
													$('.js-three-stars-percent').text(percThreeStars + "%");
													
													var percTwoStars = Math.round((topResultsArray[thisIndex].freq.freq_2stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
													$('.js-two-stars').text(topResultsArray[thisIndex].freq.freq_2stars);
													$('.js-two-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percTwoStars + "%");
													$('.js-two-stars-percent').text(percTwoStars + "%");
													
													var percOneStars = Math.round((topResultsArray[thisIndex].freq.freq_1stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
													$('.js-one-stars').text(topResultsArray[thisIndex].freq.freq_1stars);
													$('.js-one-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percOneStars + "%");
													$('.js-one-stars-percent').text(percOneStars + "%");
													
													$('.js-all-stars').text(topResultsArray[thisIndex].freq.freq_overall);

												})
												.on("click", function(){
													populateReviewsContent($(this).attr("data-term"));
													scrollToReviews();
												})
						);
				}
			}


			$('.tag-cloud--all').on("mouseleave", function(){
				//TODO empty ratings widget
			});

			setTimeout(function() {
				$('.tag-cloud li').each(function(){
					var $this = $(this);
					$(this).css("font-size", $this.data("font-size"));
				});
			}, 500);
		}

		function populateAppContent(appName, devName, appIconUrl, appLink) {			
			
			var appLink = $("<a>").attr("href", appLink).attr("target", "_blank").text(appName);
			if(devName != undefined) {
				$('.js-developer-name').text(devName);
			}
			if(appIconUrl != undefined) {
				$('.js-app-icon').attr("src", appIconUrl);
			}
			
			var selectedCountry = $('.js-secondary-filter .js-dropdown-trigger b').text();
			$('.js-selected-country-text').text("(" + selectedCountry + ")");
		}
		
		// Utility function
		Date.prototype.addHours= function(h){
      this.setHours(this.getHours()+h);
      return this;
    }
		
		$(window).on("load", function(){
		  new Page();
			$("body").on("click", function(){
				$('.js-search-results-drop-down').hide();
			});
			$('.js-select-box').each(function() {
  			new FilterDropDown($(this));
  		});
			
			var typingTimer;
			
			$('.js-app-search-input').keyup(function(){
				
				$('.js-search-results-drop-down').show();
				$('.js-app-search-loading-indicator').show();
				$('.js-search-results-drop-down li').remove();

				if(typingTimer) {
					clearTimeout(typingTimer);
				}

				var valueToSearch = $(this).val();
				typingTimer = setTimeout(function(){
					var myHeaders = new Headers();
					// myHeaders.append('Authorization', 'Basic ZWxhc3RpYzplWFBsSTUxeFU2Z29OOTI3');
					myHeaders.append('Content-Type', 'application/json');

					 var myInit = { method: 'POST',
						 headers: myHeaders,
						 mode: 'cors',
						 cache: 'default',
						 body: JSON.stringify({
								"query": {
									"function_score": {
										"query": {
											"match": {
												"application_name": {
													"query": valueToSearch,
													"fuzziness": "AUTO"
												}
											}
										},
										"script_score": {
											"script": {
												"inline": "Math.log(2 + doc['downloads'].value + doc['revenue'].value) + _score * 2.5"
											}
										}
									}
								}
							})
					 };
					
					var myInitNewSearchURL = { method: 'GET',
						 headers: myHeaders,
						 mode: 'cors',
						 cache: 'default',
					 };
					// previous search URL https://es.reflection.io:9200/ios/_search
					
					fetch('https://oli-4395-dot-reflection-live.appspot.com/webapp/search/iosapp?term=' + valueToSearch, myInitNewSearchURL).then(function(response) {
						return response.json().then(function(json) {
							if(json && json.data && json.data.length) {
								
								var searchResultsDropDown = $('.js-search-results-drop-down');
								$.each(json.data, function(i, result){
									// console.log(result);
									searchResultsDropDown.append($("<li>").attr("data-appid", result.appId).attr("data-appDeveloper", result.developerName).append($("<img>").attr("src", result.appIcon)).append($("<span>").text(result.appName)).on("click", function(){
										var $this = $(this);
										var selectedAppId = $this.attr("data-appId");										
										var selectedAppName = $this.text();
										var selectedAppDeveloper = $this.attr("data-appDeveloper");
										$('.js-app-search-input').val(selectedAppName).attr("data-appId", selectedAppId);
										$('.js-search-results-drop-down').hide();
										populateAppContent(result.appName, result.developerName, result.appIcon, "https://www.reflection.io/#app:%7B%22countryRankHistory%22:%22gb%22,%22store%22:%22iOS%22,%22appTab%22:%22ratings_and_info%22,%22iosDeviceRankHistory%22:%22iPhone%22,%22myData%22:false,%22appId%22:%22" + selectedAppId + "%22,%22countriesRevenueDownloads%22:%5B%22au%22,%22br%22,%22ca%22,%22dk%22,%22fr%22,%22de%22,%22id%22,%22ie%22,%22it%22,%22my%22,%22mx%22,%22nz%22,%22no%22,%22pt%22,%22ru%22,%22sa%22,%22sg%22,%22es%22,%22se%22,%22tr%22,%22ae%22,%22gb%22,%22us%22%5D,%22iosDeviceRevenueDownloads%22:%5B%22iPhone%22,%22iPad%22,%22DesktopIos%22,%22OtherIosDevices%22%5D%7D");	
										generateReviewsCloud();
									}));
									
									$('.js-app-search-loading-indicator').hide();
								});
							}
						});
					}).catch(function(error) {
						console.log('There has been a problem with the fetch operation: ' + error.message);
					});
				}, 500);
			});

			$('.js-toggle input').each(function(){
				var cloudToToggle = $(this).data("cloudtotoggle");
				if($(this).is(":checked")) {
					$('.' + cloudToToggle).fadeIn();
				} else {
					$('.' + cloudToToggle).hide();
				}
			});

			$('.js-toggle input').change(function(){
				var cloudToToggle = $(this).data("cloudtotoggle");
				if($(this).is(":checked")) {
					$('.tag-cloud').hide();
					$('.' + cloudToToggle).fadeIn();
				}
			});

  		$("html").on("click", function(e){
				if(!$(e.target).hasClass("js-no-close-on-click") && !$(e.target).hasClass("js-clear-all")) {
					closeAllFilters();
				}
			});
			
			
			// HIGHCHARTS
  		var monthNames = [
        "Jan", "Feb", "Mar",
        "Apr", "May", "Jun", "Jul",
        "Aug", "Sep", "Oct",
        "Nov", "Dec"
      ];

      var hasBeenSet = false,
      		lastPoint;

	    (function (H) {
				
				H.setOptions({
					global : {
						useUTC : false
					}
				});
				
	      var customIconRect;
	      H.wrap(H.Tooltip.prototype, 'refresh', function (proceed) {
	      	
	        proceed.apply(this, Array.prototype.slice.call(arguments, 1));

	        if(this.chart.customIconRect !== undefined) {
	          this.chart.customIconRect.destroy();
	        }

	        var $axisLabel = $(this.chart.container).find('.highcharts-axis-label'),
	            leftOffset = 26,
	            axisLabelYPos = $("#" + arguments[1][0].series.chart.container.id + "").height() - arguments[1][0].series.xAxis.bottom,
	            //axisLabelYPos = arguments[1][0].series.chart.containerHeight - arguments[1][0].series.xAxis.bottom,
	            axisLabelXPos = arguments[1][0].plotX - leftOffset,
	            timeStampString = arguments[1][0].x + "",
	            timeStampString = timeStampString.substring(0,10),
	            xAxisDate = new Date(timeStampString*1000),
	            formattedDate = xAxisDate.getDate() + " " + monthNames[xAxisDate.getMonth()];

	        if($axisLabel.length > 0) {       

	          var labelYPos = axisLabelYPos + 22,
	              labelXPos = axisLabelXPos + 7;

	          $axisLabel.attr("transform", "translate(" + labelXPos + "," + labelYPos + ")");
	          $axisLabel.find("text").text(formattedDate);

	        } else {
	          this.chart.renderer.label(formattedDate, axisLabelXPos+7, axisLabelYPos + 22, 'callout', 0, 0, false, true, "axis-label")
	          .css({
	            color: '#fcfdfd',
	            fontSize: '12px',
	            fontFamily: 'Source Sans Pro',
	            fontWeight: 600
	          })
	          .attr({
	            zIndex: 100
	          })
	          .add();
	        }

	        this.chart.customIconRect = this.chart.renderer.image('images/axis-label-background.png', axisLabelXPos, axisLabelYPos + 8, 54, 20)
	        .attr({
	          zIndex: 99
	        })
	        .add();
	      });

				H.wrap(H.Series.prototype, 'hide', function (proceed) {

				  // Before the hide function
				  var t = $(this),
				  				par;

				  if(t[0].type == "area") {
				  	if(this.graph != undefined) {
				  		par = $(this.graph.element).parents('.highcharts-series').attr("class", "highcharts-series is-transparent-fade");
				  	}				  	
				  }

				  var instance = this;
				
				  setTimeout(function() {
				  	proceed.apply(instance, Array.prototype.slice.call(arguments, 1));
				  	if(t[0].type == "area" && par != undefined) {
				  		par.attr("class", "highcharts-series");
				  	}
				  }, 200);
				});

				H.Chart.prototype.animateSelectedLines = function(containerId, indexToSelect, previousSelectedIndex) {
	    		$(containerId + ' .highcharts-series path:nth-child(2)').each(function(){
	          var $this = $(this);
	          if($this.attr("data-index") == indexToSelect) {
	            $this.css("opacity", "0.3");
	            $this.animate({ "opacity": 1 }, 250);
	            $this.siblings("path").css("opacity", "0");
	            $this.siblings("path").animate({ "opacity": 1 }, 250);

	          } else if($this.attr("data-index") == previousSelectedIndex) {
	          	$this.css("opacity", 1);
	            $this.animate({ "opacity": 0.3 }, 250);
	            $this.siblings("path").css("opacity", 1);
	            $this.siblings("path").animate({ "opacity": 0 }, 250);
	          }
	        });
	    	}

	    	H.Chart.prototype.setSeriesToSelected = function(chartIndex, seriesIndex) {
	    		H.charts[chartIndex].series[seriesIndex].selected = true;
	    		if(H.charts[chartIndex].series[seriesIndex].graph) {
	    			H.charts[chartIndex].series[seriesIndex].graph.element.setAttribute("data-selected", "selected");
	    		}	      	
	    	}

	    	H.Chart.prototype.setSeriesToUnselected = function(chartIndex, seriesIndex) {
	    		$('.chart[data-highcharts-chart="' + chartIndex + '"] .highcharts-series path[data-selected]').removeAttr("data-selected");
	      	H.charts[chartIndex].series[seriesIndex].selected = false;
	    	}

				H.Chart.prototype.setGraphFillsTransparency = function() {
					$.each(H.charts, function(key, chart) {
						$.each(chart.series, function (key, series) {
							if(series.graph != undefined) {
		        		series.graph.parentGroup.element.children[0].setAttribute("style", "opacity: 0.25");
							}
						});  	
					});
				}

				H.Chart.prototype.highlightAChartSeries = function(chartContainerId, seriesToHighlight) {
				$('#' + chartContainerId + ' .series-class-' + seriesToHighlight).each(function(){
					var $this = $(this);
					$this.css("opacity", 0.3);
          $this.animate({ "opacity": 1 }, 100);
				});
			}

			H.Chart.prototype.unhighlightAChartSeries = function(chartContainerId, seriesToUnhighlight) {
				$('#' + chartContainerId + ' .series-class-' + seriesToUnhighlight).each(function(){
					var $this = $(this);
					$this.css("opacity", "1");
          $this.animate({ "opacity": 0.3 }, 100);
				});
			}

	    }(Highcharts));

		});

  </script>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5513f37846b6ec2e"></script> 
</body>