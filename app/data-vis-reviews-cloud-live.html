<!doctype html>
<html lang="en" class="no-js" ng-app="reflectionApp">
<head>
	<meta charset="utf-8" />
	<title>Reflection Data Lab, App Reviews Analysis</title>
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<link rel="stylesheet" media="screen, projection" type="text/css" href="reflection-main-v2.css" />
<script src="https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js"></script>
<link rel="stylesheet" href="js/vendor/jquery.mCustomScrollbar.css" />
<script>
  WebFont.load({
    google: {
      families: ['Open Sans:400,600,700,400italic,600italic', 'Source Sans Pro:400,600,700', 'Lato:400,700,400italic']
    }
  });
</script> <script src="js/vendor/modernizr.2.8.3.custom.min.js"></script></head>
<body>
	<!--[if (lt IE 9)]>
      <div class="window-warning">
  			<p>Uh oh... Reflection doesn't work in this browser. &nbsp; &nbsp;<a href="http://outdatedbrowser.com/en" target="_blank">Download a compatible browser</a></p>
  		</div>
  <![endif]-->
  <header id="js-component-import--global-header" class="global-header"></header>
  
	<div id="js-component-import--panel-left" class="panel-left js-panel-left js-custom-scrollbar" data-mcs-theme="minimal-dark"></div>

	<div class="l-page-container">
		<div id="main" class="l-main" role="main">
			<div class="page-lab-base grid-container page-data-vis-reviews-cloud theme-dark is-initial-state">

				<img src="images/data-lab-article-making-top-mock-data.png" alt="Sharing image of the chart" style="position: fixed; left: -999rem;" />

				<div class="grid__row">
					<div class="grid__row--heading-row__right">
	 					<div class="sharing-container">
	 						<div class="addthis_sharing_toolbox"></div>
	 					</div>
					</div>
				</div>

				<div class="data-lab-article-intro">
					<h1 class="data-lab-article-intro__heading">App Store Reviews Hold the Key to Improving User Sentiment</h1>
					<p class="data-lab-article-intro__paragraph">The ability to quickly see what people are saying about an app and why is essential in helping weed out issues or exploit opportunities. Enter Reflectionâ€™s Review Investigator tool: Find an App to see the most commonly used words in the latest reviews (positive and negative) then click on them to see the context in which they were used.</p>
				</div>				
				
				<div class="page-data-vis-reviews-cloud__center-column">
					<div class="page-data-vis-reviews-cloud__main-content-container">
						<div class="filters-row js-reviews-cloud-filters-row">
							<div class="overflow-visible">
								<div class="secondary-filter secondary-filter--medium form-field--search">
									<input type="text" placeholder="Find an App" name="appId" id="appId" class="js-app-search-input" />
									<label for="findapp" class="ref-icon-after--search"><span>Search</span></label>
									<a href="#" class="clear-search ref-icon-after--close js-clear-search">Clear</a>
									<ul class="form-field--select__dropdown js-search-results-drop-down" style="min-width: 250px; display: none; left: -2px; top: 42px;">
										<div class="app-search-loading-indicator js-app-search-loading-indicator" style="display: none;">
											<span>Searching...</span>
											<img src="images/loadingSpinner.gif" alt="Loading" class="search-loading-indicator" /></div>
									</ul>
								</div>
								
								<div class="secondary-filter secondary-filter--medium form-field--select js-secondary-filter js-dropdown-country">
									<select class="js-select-box">
										<option value="GB" selected="selected" class="icon-flag-sm icon-flag--GB">United Kingdom</option>
										<option value="US" class="icon-flag-sm icon-flag--US">USA</option>
										<option value="AU" class="icon-flag-sm icon-flag--AU">Australia</option>
										<option value="BR" class="icon-flag-sm icon-flag--BR">Brazil</option>
										<option value="CA" class="icon-flag-sm icon-flag--CA">Canada</option>
										<option value="DK" class="icon-flag-sm icon-flag--DK">Denmark</option>
										<option value="FR" class="icon-flag-sm icon-flag--FR">France</option>
										<option value="DE" class="icon-flag-sm icon-flag--DE">Germany</option>
										<option value="ID" class="icon-flag-sm icon-flag--ID">Indonesia</option>
										<option value="IE" class="icon-flag-sm icon-flag--IE">Ireland</option>
										<option value="IT" class="icon-flag-sm icon-flag--IT">Italy</option>
										<option value="MY" class="icon-flag-sm icon-flag--MY">Malaysia</option>
										<option value="MX" class="icon-flag-sm icon-flag--MX">Mexico</option>
										<option value="NZ" class="icon-flag-sm icon-flag--NZ">New Zealand</option>
										<option value="NO" class="icon-flag-sm icon-flag--NO">Norway</option>
										<option value="PT" class="icon-flag-sm icon-flag--PT">Portugal</option>
										<option value="RU" class="icon-flag-sm icon-flag--RU">Russia</option>
										<option value="SA" class="icon-flag-sm icon-flag--SA">Saudi Arabia</option>
										<option value="SG" class="icon-flag-sm icon-flag--SG">Singapore</option>
										<option value="ES" class="icon-flag-sm icon-flag--ES">Spain</option>
										<option value="SE" class="icon-flag-sm icon-flag--SE">Sweden</option>
										<option value="TR" class="icon-flag-sm icon-flag--TR">Turkey</option>
										<option value="AE" class="icon-flag-sm icon-flag--AE">United Arab Emirates</option>
									</select>
								</div>
							</div>

							<div class="toggle-container filter-toggle filter-toggle--with-text filter-toggle--medium">
								<div class="toggle js-toggle">
									<input id="toggle--show-all" name="radiomedium" data-cloudtotoggle="tag-cloud--all" checked="" type="radio">
									<label for="toggle--show-all">
										All Reviews
									</label>
								</div>
								<div class="toggle js-toggle">
									<input id="toggle--show-five" name="radiomedium" data-cloudtotoggle="tag-cloud--positive" type="radio">
									<label for="toggle--show-five">
										4 - 5 Stars
									</label>
								</div>
								<div class="toggle js-toggle">
									<input id="toggle--show-three" name="radiomedium" data-cloudtotoggle="tag-cloud--average" type="radio">
									<label for="toggle--show-three">
										3 Stars
									</label>
								</div>
								<div class="toggle js-toggle">
									<input id="toggle--show-one" name="radiomedium" data-cloudtotoggle="tag-cloud--negative" type="radio">
									<label for="toggle--show-one">
										1 - 2 Stars
									</label>
								</div>
							</div>
							
							<div class="cloud-key-instruction-container">
								<h2 class="cloud-key-instruction">Click a word to read reviews featuring it</h2>
								<h3 class="cloud-key"><span class="size-key">Siz<b>e</b></span> = Frequency</h3>
								<h3 class="cloud-key"><span class="colour-key">Colour</span> = Sentiment</h3>
							</div>
						</div>

						<div>
							<aside class="page-data-vis-reviews-cloud__app-column">
								<div class="page-data-vis-reviews-cloud__app-column__app-icon-container">
									<img 
										src="images/data-vis-reviews-cloud-app-icon-placeholder.jpg"
										alt="App Name"
										class="js-app-icon" />
								</div>
								<h2 class="page-data-vis-reviews-cloud__app-name heading-style--heading-three js-app-name">App Title</h2>
								<h3 class="page-data-vis-reviews-cloud__developer-name js-developer-name">Developer Name</h3>

								<div class="page-data-vis-reviews-cloud__reviews-widget">
									<h4>Times <span class="js-keyword-hover">'Keyword'</span> Appears in Recent Reviews</h4>
									<h5>Total <span class="selected-country-text js-selected-country-text"></span>: <span class="total-reviews-count js-all-stars">-</span></h5>
									<ul>
										<li>
											<span class="number-of-stars-label ref-icon-after--star">5</span>
											<span class="rating-number js-five-stars"></span>
											<div class="rating-percentage-container"><div class="rating-percentage"></div></div>
											<span class="rating-percentage-text js-five-stars-percent">%</span>
										</li>
										<li>
											<span class="number-of-stars-label ref-icon-after--star">4</span>
											<span class="rating-number js-four-stars"></span>
											<div class="rating-percentage-container"><div class="rating-percentage"></div></div>
											<span class="rating-percentage-text js-four-stars-percent">%</span>
										</li>
										<li>
											<span class="number-of-stars-label ref-icon-after--star">3</span>
											<span class="rating-number js-three-stars"></span>
											<div class="rating-percentage-container"><div class="rating-percentage"></div></div>
											<span class="rating-percentage-text js-three-stars-percent">%</span>
										</li>
										<li>
											<span class="number-of-stars-label ref-icon-after--star">2</span>
											<span class="rating-number js-two-stars"></span>
											<div class="rating-percentage-container"><div class="rating-percentage"></div></div>
											<span class="rating-percentage-text js-two-stars-percent">%</span>
										</li>
										<li>
											<span class="number-of-stars-label ref-icon-after--star">1</span>
											<span class="rating-number js-one-stars"></span>
											<div class="rating-percentage-container"><div class="rating-percentage"></div></div>
											<span class="rating-percentage-text js-one-stars-percent">%</span>
										</li>
									</ul>
								</div>
							</aside>

							<div class="page-data-vis-reviews-cloud__cloud-section">
								<div class="tag-cloud-container" style="margin-bottom: 6rem;">
									
									<div class="chart__loading">
										<div class="hamster-wheel">
											<img src="images/hamster-wheel-dark.png" alt="hamster wheel">
										</div>
										<div class="animation-hamster animation-hamster--dark"></div>
									</div>
									
									<div class="chart__no-data">
										<div class="animation-hamster-no-data-dark"></div>
    								<div>
											<h2>No Reviews Found</h2>
											<p>Sorry, we couldn't retrieve any reviews for the chosen app and country. Try changing the app name or the country above.</p>
										</div>
									</div>
									
									<div class="start-instruction">
										<img src="images/onboarding-find-an-app.png" alt="Find an app to get started" />
									</div>
									
									<ul class="tag-cloud tag-cloud--all"></ul>
									<ul class="tag-cloud tag-cloud--positive"></ul>
									<ul class="tag-cloud tag-cloud--average"></ul>
									<ul class="tag-cloud tag-cloud--negative"></ul>
									<div class="reviews-content-container js-reviews-content-container">
										<h2 class="heading-style--heading-five">Latest Reviews Featuring <span class="reviews-content-container__keyword js-keyword">...</span></h2>
										<div class="ratings-list js-custom-scrollbar" data-mcs-theme="minimal-dark">
											<ul class="js-reviews-content">
												<li>
													<h2 class="reviews-content__title">Click a term above to see the reviews it appears in</h2>
												</li>
											</ul>
										</div>
									</div>

<!--
									<div class="feedback-container">
											<svg x="0px" y="0px"
	     viewBox="0 0 58.4 99.6" enable-background="new 0 0 58.4 99.6" xml:space="preserve">
	<path fill="#6D69C5" d="M51.6,70.4c0,12.3-10,22.4-22.4,22.4S6.8,82.8,6.8,70.4H51.6z" class="lab-bottle-liquid" />
	<path fill="#5A5A68" d="M40.6,43.5V8.8h1.7c2.4,0,4.4-2,4.4-4.4S44.7,0,42.3,0H16.1c-2.4,0-4.4,2-4.4,4.4s2,4.4,4.4,4.4h1.1v35
	    C6.7,48.5,0,58.8,0,70.4c0,16.1,13.1,29.2,29.2,29.2c16.1,0,29.2-13.1,29.2-29.2C58.4,58.7,51.3,48,40.6,43.5z M16.1,3h26.1
	    c0.8,0,1.4,0.6,1.4,1.4c0,0.7-0.5,1.2-1.1,1.4H15.9c-0.6-0.1-1.1-0.7-1.1-1.4C14.7,3.6,15.4,3,16.1,3z M29.2,96.6
	    C14.8,96.6,3,84.9,3,70.4c0-10.7,6.4-20.2,16.3-24.3l0.9-0.4V7h17.3v38.6l1,0.4c10.1,3.8,16.9,13.7,16.9,24.5
	    C55.4,84.9,43.7,96.6,29.2,96.6z" />
	</svg>
											<div>
												<h2 class="heading-style--heading-three">Would You Use This Feature?</h2>
												<p>Let us know with this <a href="">quick 2 question survey</a> so we can build it with your help.</p>
											</div>
										</div>

										<div class="idc-comments-container">
											<script>
												var idcomments_acct = 'c4a0cfaab22f16bc5e847b0d1398bb91';
												var idcomments_post_id;
												var idcomments_post_url;
												</script>
												<span id="IDCommentsPostTitle" style="display:none"></span>
											<script type='text/javascript' src='https://www.intensedebate.com/js/genericCommentWrapperV2.js'></script>
										</div>

								</div>
-->
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div class="grid-container global-footer-dark global-footer-dark--lab" id="js-component-import--global-footer"></div>

	<div id="js-component-import--account-container" class="panel-right-container js-account-container"></div>
	<div id="js-component-import--search-container" class="panel-right-container js-search-container"></div>

 	<script src="js/vendor/jquery-1.11.1.min.js"></script>
 	<script src="js/vendor/handlebars-v2.0.0.js"></script> <!-- static templates only -->
 	<script src="js-v2/templates/templates.js"></script> <!-- static templates only -->
 	<script src="js/vendor/modernizr.2.8.3.custom.min.js"></script>

	<script src="js/vendor/jquery.mCustomScrollbar.concat.min.js"></script>

	<div id="js-appendScriptsContainer"></div>

	<script src="js-v2/app-include-templates.js"></script> <!-- static templates only -->
  <script src="js-v2/application.js"></script>

  <script>
		
		var rawReviews = {};

		if (!String.prototype.splice) {
		    String.prototype.splice = function(start, delCount, newSubStr) {
		        return this.slice(0, start) + newSubStr + this.slice(start + Math.abs(delCount));
		    };
		}

		function shuffle(array) {
		  var currentIndex = array.length, temporaryValue, randomIndex;

		  // While there remain elements to shuffle...
		  while (0 !== currentIndex) {

		    // Pick a remaining element...
		    randomIndex = Math.floor(Math.random() * currentIndex);
		    currentIndex -= 1;

		    // And swap it with the current element.
		    temporaryValue = array[currentIndex];
		    array[currentIndex] = array[randomIndex];
		    array[randomIndex] = temporaryValue;
		  }

		  return array;
		}

		function populateReviewsContent(term) {
			// find reviews that contain the term
			$('.js-reviews-content-container').show();
			
			var currentCloud = $('.js-reviews-cloud-filters-row .filter-toggle input:checked').attr("data-cloudtotoggle");
			var filterByRating = null;
			var filterByRatingMin = null;
			var filterByRatingMax = null;
			if(currentCloud == "tag-cloud--positive") {
				filterByRating = true;
				filterByRatingMin = 4;
				filterByRatingMax = 5;
			} else if(currentCloud == "tag-cloud--average") {
				filterByRating = true;
				filterByRatingMin = 3;
				filterByRatingMax = 3;
			} else if(currentCloud == "tag-cloud--negative") {
				filterByRating = true;
				filterByRatingMin = 0;
				filterByRatingMax = 2;
			}
			
			var reviewsToOutput = [];
			var counter = 0;
			for(var i = 0; i < rawReviews.length; i++) {
				if(rawReviews[i].content.toLowerCase().indexOf(term.toLowerCase()) > -1) {
					if(filterByRating == null) {
						reviewsToOutput.push(rawReviews[i]);
						counter++;
					} else {
						if(rawReviews[i].rating >= filterByRatingMin && rawReviews[i].rating <= filterByRatingMax) {
							reviewsToOutput.push(rawReviews[i]);
							counter++;
						}
					}
				}
			}
			
			$('.js-reviews-content').empty();
			$('.js-keyword').text("'" + term + "'");

			for(var i = 0; i < reviewsToOutput.length; i++) {

				var contentString = reviewsToOutput[i].content;
				var indexOfString = reviewsToOutput[i].content.toLowerCase().indexOf(term);
				var wordLength = term.length;
				var formattedContent = contentString.splice(indexOfString + wordLength, 0, "</strong>");
				formattedContent = formattedContent.splice(indexOfString, 0, "<strong>");

				var ratingsContainer = $("<div>").addClass("ratings-container").append($("<div>").addClass("ratings-full").css("width", ((reviewsToOutput[i].rating / 5) * 100) + "%"));
				var reviewTitle = $("<h2>").addClass("reviews-content__title").text(reviewsToOutput[i].title);
				var reviewDate = new Date(reviewsToOutput[i].date);
				var formattedReviewDate = reviewDate.getDate() + "/" + (reviewDate.getMonth()+1) + "/" + reviewDate.getFullYear();
				var reviewDate = $("<span>").addClass("reviews-content__date").text(formattedReviewDate);
				var reviewContent = $("<p>").html(formattedContent);

				$('.js-reviews-content').append($("<li>").append(ratingsContainer)
																									.append(reviewTitle)
																									.append(reviewDate)
																									.append(reviewContent)
																				);
			}
		}
		
		function generateReviewsCloud() {
				
			$('.tag-cloud--all').empty();			
			$('.tag-cloud--positive').empty();
			$('.tag-cloud--average').empty();
			$('.tag-cloud--negative').empty();
			
			$('.is-initial-state').removeClass("is-initial-state")
			$('body').addClass("is-loading-data");
			$('body').removeClass("is-no-data");
			var myHeaders = new Headers();
			var myInit = { method: 'GET',
					 headers: myHeaders,
					 mode: 'cors',
					 cache: 'default',
			};

			var appId = $('.js-app-search-input').attr("data-appid");
			var countryCode = $('.js-dropdown-country .js-dropdown-trigger').attr("data-value");

			fetch('https://stats.reflection.io/microservices/wordcloud?itemid=' + appId + '&country=' + countryCode, myInit).then(function(response) {
				return response.json().then(function(json) {
					if(json.reviewsCloudData) {
						var reviewsCloud = {
							data: json.reviewsCloudData
						};

						rawReviews = json.reviewsRaw;

						if(json.appIcon) {
							$('.js-app-icon').attr("src", json.appIcon);
						}

						$('body').removeClass("is-loading-data");
						$('body').removeClass("is-no-data");
						populateAppContent(json.appName, json.devName, json.appIcon, reviewsCloud, "http://reflection.io/");	
					} else {
						// show cannot find reviews
						$('body').removeClass("is-loading-data");
						$('body').addClass("is-no-data");
					}
				});
			}).catch(function(error) {
				console.log('There has been a problem with the fetch operation: ' + error.message);
			});
		};
		
		var FilterDropDown = function($domElement) {

			var $thisSelectBox = $domElement,
					$dropDownContainer = $("<ul>").addClass("form-field--select__dropdown"),
					$currentValue = $("<span>").addClass("form-field--select__box ref-icon-after--angle-down js-dropdown-trigger").attr("data-value", "GB");

			$thisSelectBox.find('option').each(function(){
				
				var $thisOption = $(this),
						selectedClass = "",
						cssClass = $thisOption.attr("class");

						if($($thisOption).is(":selected")) {
							if($thisOption.val() != "") {

								selectedClass = "is-selected";
								var countryFlag = $("<span>").addClass(cssClass);
								var triggerText = $("<b>").text($thisOption.text());
								$currentValue.append(countryFlag);
								$currentValue.append(triggerText);
							}
						}

				if($thisOption.val() != "") {

					var accessClass = "";
					if($thisOption.data("access")) {
						accessClass = "ref-icon-after--key";
					}

					var $newListItem = $("<li>");
					$dropDownContainer.append($newListItem
																				.addClass("js-dropdown-option")
																				.addClass(selectedClass)
																				.addClass(accessClass)
																				.attr('data-icon-flag', cssClass)
																				.attr('data-value', $thisOption.attr('value'))
																				.on("click", function() {
																					var $this = $(this);
																					$('.js-dropdown-trigger').attr("data-value", $(this).attr("data-value"));	
																					if($('.js-app-search-input').val()) {
																						generateReviewsCloud();
																					}
																					closeAllFilters();

																					$('.js-dropdown-option.is-selected').removeClass("is-selected");
																					$this.addClass("is-selected");
																					$('.js-dropdown-trigger').empty();
																					var countryIcon = $("<span>").addClass($this.attr("data-icon-flag"));
																					$('.js-dropdown-trigger').append(countryIcon);
																					var triggerText = $("<b>").text($thisOption.text());
																					$('.js-dropdown-trigger').append(triggerText);
																				})
																				.append($("<span>").addClass(cssClass))
																				.append($("<span>").text($thisOption.text()))
																	);
				}
			});

			$currentValue.on("click", function(){
				if(!$thisSelectBox.attr("disabled")) {
					var $parentDiv = $thisSelectBox.parent("div");
					if($parentDiv.hasClass("is-open")) {
						$dropDownContainer.toggle();	
						$parentDiv.toggleClass("is-open");
					} else {
						setTimeout(function(){
							if(!$parentDiv.hasClass("is-open")) {
								closeAllFilters();
							}
							var parentWidth = $parentDiv.width();
							var parentHeight = $parentDiv.height();
							$dropDownContainer.css({"min-width": parentWidth + "px"});
							$dropDownContainer.toggle();	
							$parentDiv.toggleClass("is-open");
						}, 50); // allow time for instance.closeAllFilters() to close other filters first
					}
				}
			});

			if($currentValue.text() == "") {
				$thisSelectBox.parent("div").addClass("nothing-selected");
			}

			$thisSelectBox.parent("div").append($currentValue)
																	.append($dropDownContainer);
		}

		function closeAllFilters() {
			$('.js-secondary-filter.is-open .form-field--select__dropdown').hide();
			$('.js-secondary-filter.is-open').removeClass("is-open");
		}

		function scrollToReviews() {
			var scrollTo = $('.js-reviews-content-container').offset().top;
			$("html, body").animate({scrollTop: scrollTo - 100}, '500');
		}

		function handleData(cloudData) {

			$('.tag-cloud--all').empty();			
			$('.tag-cloud--positive').empty();
			$('.tag-cloud--average').empty();
			$('.tag-cloud--negative').empty();
			$('.js-reviews-content').empty().append($('<li><h2 class="reviews-content__title">Click a term above to see the reviews it appears in</h2></li>'));
		
			var minFontSize = 1,
					maxFontSize = 7;

			var topResultsArray = [];

			for(var t = 0; t < 100; t++) {
				topResultsArray.push(cloudData[t]);
			}

			// shuffle the sorted results
			shuffle(topResultsArray);
			var highestFrequency = cloudData[0].freq.freq_overall;
			var positiveReviewTotals = [],
				averageReviewTotals = [],
				negativeReviewTotals = [];

			for(var t = 0; t < topResultsArray.length; t++) {
				var fontSize = topResultsArray[t].freq.freq_overall / highestFrequency * maxFontSize + 0.5;
				var total = topResultsArray[t].freq.freq_overall;
				var cssClass = "negative-average";
				if(topResultsArray[t].freq.average_rating > 2.5 && topResultsArray[t].freq.average_rating < 3.5) {
					cssClass = "average-average";
				} else if(topResultsArray[t].freq.average_rating > 3.5) {
					cssClass = "positive-average";
				}
				$('.tag-cloud--all').append(
					$("<li>").addClass(cssClass)
										.text(topResultsArray[t].term)
										.data("font-size", fontSize + "rem")
										.data("index", t)
										.data("total", total)
										.data("average", topResultsArray[t].freq.average_rating)
										.attr("data-term", topResultsArray[t].term)
										.on("mouseenter", function(){
											var thisTerm = $(this).text();
											$('.js-keyword-hover').text("'" + thisTerm + "'");

											var thisIndex = $(this).data("index");
											var totalFromTag = $(this).data("total");
											
											var percFiveStars = Math.round((topResultsArray[thisIndex].freq.freq_5stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
											$('.js-five-stars').text(topResultsArray[thisIndex].freq.freq_5stars);
											$('.js-five-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percFiveStars + "%");
											$('.js-five-stars-percent').text(percFiveStars + "%");

											var percFourStars = Math.round((topResultsArray[thisIndex].freq.freq_4stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
											$('.js-four-stars').text(topResultsArray[thisIndex].freq.freq_4stars);
											$('.js-four-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percFourStars + "%");
											$('.js-four-stars-percent').text(percFourStars + "%");
											
											var percThreeStars = Math.round((topResultsArray[thisIndex].freq.freq_3stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
											$('.js-three-stars').text(topResultsArray[thisIndex].freq.freq_3stars);
											$('.js-three-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percThreeStars + "%");
											$('.js-three-stars-percent').text(percThreeStars + "%");
											
											var percTwoStars = Math.round((topResultsArray[thisIndex].freq.freq_2stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
											$('.js-two-stars').text(topResultsArray[thisIndex].freq.freq_2stars);
											$('.js-two-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percTwoStars + "%");
											$('.js-two-stars-percent').text(percTwoStars + "%");
											
											var percOneStars = Math.round((topResultsArray[thisIndex].freq.freq_1stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
											$('.js-one-stars').text(topResultsArray[thisIndex].freq.freq_1stars);
											$('.js-one-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percOneStars + "%");
											$('.js-one-stars-percent').text(percOneStars + "%");
											
											$('.js-all-stars').text(topResultsArray[thisIndex].freq.freq_overall);
										})
										.on("click", function(){											
											populateReviewsContent($(this).attr("data-term"));
											scrollToReviews();
										})
				);

				positiveReviewTotals.push(topResultsArray[t].freq.freq_5stars + topResultsArray[t].freq.freq_4stars);
				averageReviewTotals.push(topResultsArray[t].freq.freq_3stars);
				negativeReviewTotals.push(topResultsArray[t].freq.freq_2stars + topResultsArray[t].freq.freq_1stars);
			}

			positiveReviewTotals.sort(function(a, b){return b-a});
			averageReviewTotals.sort(function(a, b){return b-a});
			negativeReviewTotals.sort(function(a, b){return b-a});

			var highestPositiveReviewTotal = positiveReviewTotals[0];
			for(var t = 0; t < topResultsArray.length; t++) {
				if(topResultsArray[t].freq.freq_5stars > 0 || topResultsArray[t].freq.freq_4stars > 0) { // create cloud for positive reviews
						var fontSize = (topResultsArray[t].freq.freq_5stars + topResultsArray[t].freq.freq_4stars) / highestPositiveReviewTotal * maxFontSize + 0.5;
						var total = topResultsArray[t].freq.freq_overall;
						$('.tag-cloud--positive').append(
							$("<li>").text(topResultsArray[t].term)
												.data("font-size", fontSize + "rem")
												.data("index", t)
												.data("total", total)
												.attr("data-term", topResultsArray[t].term)
												.on("mouseenter", function(){
													var thisTerm = $(this).text();
													$('.js-keyword-hover').text("'" + thisTerm + "'");

													var thisIndex = $(this).data("index");
													var totalFromTag = $(this).data("total");

													var percFiveStars = Math.round((topResultsArray[thisIndex].freq.freq_5stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
													$('.js-five-stars').text(topResultsArray[thisIndex].freq.freq_5stars);
													$('.js-five-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percFiveStars + "%");
													$('.js-five-stars-percent').text(percFiveStars + "%");

													var percFourStars = Math.round((topResultsArray[thisIndex].freq.freq_4stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
													$('.js-four-stars').text(topResultsArray[thisIndex].freq.freq_4stars);
													$('.js-four-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percFourStars + "%");
													$('.js-four-stars-percent').text(percFourStars + "%");
													
													var percThreeStars = Math.round((topResultsArray[thisIndex].freq.freq_3stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
													$('.js-three-stars').text(topResultsArray[thisIndex].freq.freq_3stars);
													$('.js-three-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percThreeStars + "%");
													$('.js-three-stars-percent').text(percThreeStars + "%");
													
													var percTwoStars = Math.round((topResultsArray[thisIndex].freq.freq_2stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
													$('.js-two-stars').text(topResultsArray[thisIndex].freq.freq_2stars);
													$('.js-two-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percTwoStars + "%");
													$('.js-two-stars-percent').text(percTwoStars + "%");
													
													var percOneStars = Math.round((topResultsArray[thisIndex].freq.freq_1stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
													$('.js-one-stars').text(topResultsArray[thisIndex].freq.freq_1stars);
													$('.js-one-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percOneStars + "%");
													$('.js-one-stars-percent').text(percOneStars + "%");
													
													$('.js-all-stars').text(topResultsArray[thisIndex].freq.freq_overall);

												})
												.on("click", function(){
													populateReviewsContent($(this).attr("data-term"));
													scrollToReviews();
												})
						);
				}
			}

			var highestAverageReviewTotal = averageReviewTotals[0];
			for(var t = 0; t < topResultsArray.length; t++) {
				if(topResultsArray[t].freq.freq_3stars > 0) { // create cloud for average reviews
						var fontSize = (topResultsArray[t].freq.freq_3stars) / highestAverageReviewTotal * maxFontSize + 0.5;
						var total = topResultsArray[t].freq.freq_overall;
						$('.tag-cloud--average').append(
							$("<li>").text(topResultsArray[t].term)
												.data("font-size", fontSize + "rem")
												.data("index", t)
												.data("total", total)
												.attr("data-term", topResultsArray[t].term)
												.on("mouseenter", function(){

													var thisTerm = $(this).text();
													$('.js-keyword-hover').text("'" + thisTerm + "'");

													var thisIndex = $(this).data("index");
													var totalFromTag = $(this).data("total");

													var percFiveStars = Math.round((topResultsArray[thisIndex].freq.freq_5stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
													$('.js-five-stars').text(topResultsArray[thisIndex].freq.freq_5stars);
													$('.js-five-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percFiveStars + "%");
													$('.js-five-stars-percent').text(percFiveStars + "%");

													var percFourStars = Math.round((topResultsArray[thisIndex].freq.freq_4stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
													$('.js-four-stars').text(topResultsArray[thisIndex].freq.freq_4stars);
													$('.js-four-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percFourStars + "%");
													$('.js-four-stars-percent').text(percFourStars + "%");
													
													var percThreeStars = Math.round((topResultsArray[thisIndex].freq.freq_3stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
													$('.js-three-stars').text(topResultsArray[thisIndex].freq.freq_3stars);
													$('.js-three-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percThreeStars + "%");
													$('.js-three-stars-percent').text(percThreeStars + "%");
													
													var percTwoStars = Math.round((topResultsArray[thisIndex].freq.freq_2stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
													$('.js-two-stars').text(topResultsArray[thisIndex].freq.freq_2stars);
													$('.js-two-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percTwoStars + "%");
													$('.js-two-stars-percent').text(percTwoStars + "%");
													
													var percOneStars = Math.round((topResultsArray[thisIndex].freq.freq_1stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
													$('.js-one-stars').text(topResultsArray[thisIndex].freq.freq_1stars);
													$('.js-one-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percOneStars + "%");
													$('.js-one-stars-percent').text(percOneStars + "%");
													
													$('.js-all-stars').text(topResultsArray[thisIndex].freq.freq_overall);

												})
												.on("click", function(){
													populateReviewsContent($(this).attr("data-term"));
													scrollToReviews();
												})
						);
				}
			}

			var highestNegativeReviewTotal = negativeReviewTotals[0];
			for(var t = 0; t < topResultsArray.length; t++) {
				if(topResultsArray[t].freq.freq_2stars > 0 || topResultsArray[t].freq.freq_1stars > 0) { // create cloud for negative reviews
						var fontSize = (topResultsArray[t].freq.freq_2stars + topResultsArray[t].freq.freq_1stars) / highestNegativeReviewTotal * maxFontSize + 0.5;
						var total = topResultsArray[t].freq.freq_overall;
						$('.tag-cloud--negative').append(
							$("<li>").text(topResultsArray[t].term)
												.data("font-size", fontSize + "rem")
												.data("index", t)
												.data("total", total)
												.attr("data-term", topResultsArray[t].term)
												.on("mouseenter", function(){

													var thisTerm = $(this).text();
													$('.js-keyword-hover').text("'" + thisTerm + "'");

													var thisIndex = $(this).data("index");
													var totalFromTag = $(this).data("total");

													var percFiveStars = Math.round((topResultsArray[thisIndex].freq.freq_5stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
													$('.js-five-stars').text(topResultsArray[thisIndex].freq.freq_5stars);
													$('.js-five-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percFiveStars + "%");
													$('.js-five-stars-percent').text(percFiveStars + "%");

													var percFourStars = Math.round((topResultsArray[thisIndex].freq.freq_4stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
													$('.js-four-stars').text(topResultsArray[thisIndex].freq.freq_4stars);
													$('.js-four-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percFourStars + "%");
													$('.js-four-stars-percent').text(percFourStars + "%");
													
													var percThreeStars = Math.round((topResultsArray[thisIndex].freq.freq_3stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
													$('.js-three-stars').text(topResultsArray[thisIndex].freq.freq_3stars);
													$('.js-three-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percThreeStars + "%");
													$('.js-three-stars-percent').text(percThreeStars + "%");
													
													var percTwoStars = Math.round((topResultsArray[thisIndex].freq.freq_2stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
													$('.js-two-stars').text(topResultsArray[thisIndex].freq.freq_2stars);
													$('.js-two-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percTwoStars + "%");
													$('.js-two-stars-percent').text(percTwoStars + "%");
													
													var percOneStars = Math.round((topResultsArray[thisIndex].freq.freq_1stars / topResultsArray[thisIndex].freq.freq_overall) * 100);
													$('.js-one-stars').text(topResultsArray[thisIndex].freq.freq_1stars);
													$('.js-one-stars').next(".rating-percentage-container").find(".rating-percentage").css("width", percOneStars + "%");
													$('.js-one-stars-percent').text(percOneStars + "%");
													
													$('.js-all-stars').text(topResultsArray[thisIndex].freq.freq_overall);

												})
												.on("click", function(){
													populateReviewsContent($(this).attr("data-term"));
													scrollToReviews();
												})
						);
				}
			}


			$('.tag-cloud--all').on("mouseleave", function(){
				//TODO empty ratings widget
			});

			setTimeout(function() {
				$('.tag-cloud li').each(function(){
					var $this = $(this);
					$(this).css("font-size", $this.data("font-size"));
				});
			}, 500);
		}

		function populateAppContent(appName, devName, appIconUrl, cloudReviews, appLink) {
			
			handleData(cloudReviews.data);
			
			var appLink = $("<a>").attr("href", appLink).text(appName);
			if(appName != undefined) {
				$('.js-app-name').html(appLink);
			}
			if(devName != undefined) {
				$('.js-developer-name').text(devName);
			}
			if(appIconUrl != undefined) {
				$('.js-app-icon').attr("src", appIconUrl);	
			}
			
			var selectedCountry = $('.js-secondary-filter .js-dropdown-trigger b').text();
			$('.js-selected-country-text').text("(" + selectedCountry + ")");
		}

		$(window).on("load", function(){
		  new Page();
			$("body").on("click", function(){
				$('.js-search-results-drop-down').hide();
			});
			$('.js-select-box').each(function() {
  			new FilterDropDown($(this));
  		});
			
			var typingTimer;
			
			$('.js-app-search-input').keyup(function(){
				
				$('.js-search-results-drop-down').show();
				$('.js-app-search-loading-indicator').show();
				$('.js-search-results-drop-down li').remove();

				if(typingTimer) {
					clearTimeout(typingTimer);
				}

				var valueToSearch = $(this).val();
				typingTimer = setTimeout(function(){
					var myHeaders = new Headers();
					myHeaders.append('Authorization', 'Basic ZWxhc3RpYzplWFBsSTUxeFU2Z29OOTI3');
					myHeaders.append('Content-Type', 'application/json');

					 var myInit = { method: 'POST',
						 headers: myHeaders,
						 mode: 'cors',
						 cache: 'default',
						 body: JSON.stringify({
								"query": {
									"function_score": {
										"query": {
											"match": {
												"application_name": {
													"query": valueToSearch,
													"fuzziness": "AUTO"
												}
											}
										},
										"script_score": {
											"script": {
												"inline": "Math.log(2 + doc['downloads'].value + doc['revenue'].value) + _score * 2.5"
											}
										}
									}
								}
							})
					 };

					fetch('https://es.reflection.io:9200/ios/_search', myInit).then(function(response) {
						return response.json().then(function(json) {
							console.log(json);
							if(json && json.hits && json.hits.hits.length) {
								
								var searchResultsDropDown = $('.js-search-results-drop-down');
								$.each(json.hits.hits, function(i, result){
									console.log(result);
									searchResultsDropDown.append($("<li>").attr("data-appid", result['_source'].application_id).attr("data-appDeveloper", result['_source'].developer_name).append($("<span>").text(result['_source'].application_name)).on("click", function(){
										var $this = $(this);
										var selectedAppId = $this.attr("data-appId");										
										var selectedAppName = $this.text();
										var selectedAppDeveloper = $this.attr("data-appDeveloper");
										$('.js-app-search-input').val(selectedAppName).attr("data-appId", selectedAppId);
										$('.js-search-results-drop-down').hide();
										generateReviewsCloud();
									}));
									
									$('.js-app-search-loading-indicator').hide();
								});
							}
						});
					}).catch(function(error) {
						console.log('There has been a problem with the fetch operation: ' + error.message);
					});
				}, 500);
			});

			$('.js-toggle input').each(function(){
				var cloudToToggle = $(this).data("cloudtotoggle");
				if($(this).is(":checked")) {
					$('.' + cloudToToggle).fadeIn();
				} else {
					$('.' + cloudToToggle).hide();
				}
			});

			$('.js-toggle input').change(function(){
				var cloudToToggle = $(this).data("cloudtotoggle");
				if($(this).is(":checked")) {
					$('.tag-cloud').hide();
					$('.' + cloudToToggle).fadeIn();
				}
			});

  		$("html").on("click", function(e){
				if(!$(e.target).hasClass("js-no-close-on-click") && !$(e.target).hasClass("js-clear-all")) {
					closeAllFilters();
				}
			});
			
		});

  </script>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5513f37846b6ec2e"></script> 
</body>