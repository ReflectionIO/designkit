<!doctype html>
<html lang="en" class="no-js">
<head>
	<meta charset="utf-8" />
	<title>Reflection Research Tools - Experimental Tool, Category Share Over Time</title>
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<link rel="stylesheet" type="text/css" href="research-tools-experiments.css" />
	<link rel="stylesheet" href="js/vendor/jquery.mCustomScrollbar.css" />
<script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.16/webfont.js"></script>
<script>
  WebFont.load({
    google: {
      families: ['Source Sans Pro:400,600,700', 'Lato:400,700,400italic']
    }
  });
</script>
<style>
	.highcharts-legend {
    transform: translateY(482px);
	}
</style>
</head>
<body>

  <header id="js-component-import--global-header" class="global-header"></header>
  
	<div id="js-component-import--panel-left" class="panel-left js-panel-left js-custom-scrollbar" data-mcs-theme="minimal-dark"></div>

	<div class="l-page-container">
		<div id="main" class="l-main page-research-tools-experiment" role="main">
			
			<div id="js-component-import--data-vis-banner" class="research-experiment__banner"></div>
			
			<div class="page-data-dashboard">
				<div class="grid__row chart-section">
					<ul class="tabs-content-list">
						<li class="is-active js-twin-chart-container">
							<section class="chart-container chart-container--split" style="width: 100%; height: 530px">
								<header class="chart-container__header">
									<h2 class="chart-heading heading-style--heading-three">Category Downloads Over 2016</h2>
								</header>
								<div class="chart" id="chart-revenue"></div>
							</section>
						</li>
					</ul>
				</div>
	
		</div>
	</div>

 	<script src="js/vendor/jquery-1.11.1.min.js"></script>
 	<script src="js/vendor/modernizr.2.8.3.custom.min.js"></script>

	<!--[if IE 9]>
		<script src="js/vendor/jquery.mCustomScrollbar.concat.min.js"></script>
	<![endif]-->	

	<script src="js/vendor/handlebars-v2.0.0.js"></script>
	<script src="js-v2/templates/templates.js"></script>
	<script>
		var surveyURL = "https://goo.gl/forms/0oAvhN9XviLhlbhB3";
	</script>
	<script src="js-v2/app-include-data-vis-components.js"></script>
	
	<div id="js-appendScriptsContainer"></div>	
  <script src="js-v2/application.js"></script>
  <script src="js/vendor/highcharts.5.0.9.js"></script>
  <script src="js/vendor/highslide-software/rounded-corners.js"></script>
  <script src="js/data-vis/stack_data_GB_PHONE_FREE.js"></script> <!-- mock data -->
  <script>
  	// Utility function
		Date.prototype.addHours= function(h){
      this.setHours(this.getHours()+h);
      return this;
    }

  	function initScripts() {
  		// mock menu select
  		var thisPageLink = $('#js-component-import--panel-left').find('a[href="category-stacked-chart.html"]');
		  thisPageLink.parent("li").addClass("is-selected").parents("li").addClass("is-selected is-open");

  		new Page();
  		new AllDropDowns();
  		;
  		$('.js-select-box').each(function() {
  			new FormFieldSelect($(this));
  		});
  		$('.js-multi-select-box').each(function() {
  			new FormFieldMultipleSelect($(this));
  		});
  		$('.js-tabs').each(function() {
  			new Tabs($(this));
  		});

  		$('.js-open-modal--go-pro').on("click", function(e){
				e.preventDefault();
				$('.js-page-overlay--go-pro').fadeIn(200);
				setTimeout(function(){
					$('.js-page-overlay--go-pro .js-popup-content').addClass("is-showing");
				}, 100);
			});

			$('.js-page-overlay').on("click", function(e){
				var parentIsPopupContent = false;
				$(e.target).parents("div").each(function(){
					if($(this).hasClass("js-popup-content")) {
						parentIsPopupContent = true;
					}
				});
				if(!parentIsPopupContent) {
					$('.js-page-overlay').fadeOut(100);
					$('.js-popup-content').removeClass("is-showing");
				}
			});

			$('.js-popup-close').on("click", function(e){
				e.preventDefault();
				$('.js-page-overlay').fadeOut(100);
				$('.js-popup-content').removeClass("is-showing");
			});

  		// Mock function for template
  		$('#topAppsDownloads').hide();
  		$('.js-mock-switch-revenue').on("click", function(){
  			$('#topAppsDownloads').hide();
  			$('#topAppsRevenue').show();
  		});
  		$('.js-mock-switch-downloads').on("click", function(){
  			$('#topAppsDownloads').show();
  			$('#topAppsRevenue').hide();
  		});

  		$('#topAppsDownloads-bottom').hide();
  		$('.js-mock-switch-revenue-bottom').on("click", function(){
  			$('#topAppsDownloads-bottom').hide();
  			$('#topAppsRevenue-bottom').show();
  		});
  		$('.js-mock-switch-downloads-bottom').on("click", function(){
  			$('#topAppsDownloads-bottom').show();
  			$('#topAppsRevenue-bottom').hide();
  		});


  		$('#topCountriesDownloads').hide();
  		$('.js-mock-switch-revenue-country').on("click", function(){
  			$('#topCountriesDownloads').hide();
  			$('#topCountriesRevenue').show();
  		});
  		$('.js-mock-switch-downloads-country').on("click", function(){
  			$('#topCountriesDownloads').show();
  			$('#topCountriesRevenue').hide();
  		});

  		$('#topCountriesDownloads-bottom').hide();
  		$('.js-mock-switch-revenue-country-bottom').on("click", function(){
  			$('#topCountriesDownloads-bottom').hide();
  			$('#topCountriesRevenue-bottom').show();
  		});
  		$('.js-mock-switch-downloads-country-bottom').on("click", function(){
  			$('#topCountriesDownloads-bottom').show();
  			$('#topCountriesRevenue-bottom').hide();
  		});

  		$('.js-whats-this-tooltip').each(function(){
  			new WhatsThisPopup($(this));
  		});

  		$('.js-mock-remove-row').on("click", function(e){
  			e.preventDefault();
  			$(this).parents('.chart-key-full__row').remove();
  		});

  		// chart toggles
  		$('.js-mock-show-split-chart').on("click", function(){
  			
  			$('.js-toggle--show-stacked.is-disabled').removeClass("is-disabled")
																							.siblings("input").removeAttr("disabled", "disabled");
				$('.js-toggle--show-bar.is-disabled').removeClass("is-disabled")
																							.siblings("input").removeAttr("disabled", "disabled");

  			$('.js-twin-chart-container').addClass("is-active");
  			$('.js-combined-chart-container').removeClass("is-active");
  			Highcharts.charts[0].reflow(); // reflow in case of window width change before making visible again
  			Highcharts.charts[1].reflow();
  		});

  		$('.js-mock-show-single-chart').on("click", function(){
  			if(!$(this).hasClass("is-disabled")) {

					$('.js-toggle--show-stacked').addClass("is-disabled")
																				.siblings("input").attr("disabled", "disabled");

  				$('.js-twin-chart-container').removeClass("is-active");
	  			$('.js-combined-chart-container').addClass("is-active");
	  			Highcharts.charts[2].reflow();
  			}
  		});

  		// HIGHCHARTS
  		var monthNames = [
        "Jan", "Feb", "Mar",
        "Apr", "May", "Jun", "Jul",
        "Aug", "Sep", "Oct",
        "Nov", "Dec"
      ];

      var hasBeenSet = false,
      		lastPoint;

	    (function (H) {

	      var customIconRect;
	      H.wrap(H.Tooltip.prototype, 'refresh', function (proceed) {
	      	
	        proceed.apply(this, Array.prototype.slice.call(arguments, 1));

	        if(this.chart.customIconRect !== undefined) {
	          this.chart.customIconRect.destroy();
	        }

	        var $axisLabel = $(this.chart.container).find('.highcharts-axis-label'),
	            leftOffset = 29,
	            axisLabelYPos = $("#" + arguments[1][0].series.chart.container.id + "").height() - arguments[1][0].series.xAxis.bottom,
	            //axisLabelYPos = arguments[1][0].series.chart.containerHeight - arguments[1][0].series.xAxis.bottom,
	            axisLabelXPos = arguments[1][0].plotX - leftOffset,
	            timeStampString = arguments[1][0].x + "",
	            timeStampString = timeStampString.substring(0,10),
	            xAxisDate = new Date(timeStampString*1000).addHours(12),
	            formattedDate = xAxisDate.getDate() + " " + monthNames[xAxisDate.getMonth()];

	        if($axisLabel.length > 0) {

	          var labelYPos = axisLabelYPos + 18,
	              labelXPos = axisLabelXPos + 7;

	          $axisLabel.attr("transform", "translate(" + labelXPos + "," + labelYPos + ")");
	          $axisLabel.find("text").text(formattedDate);

	        } else {
	          this.chart.renderer.label(formattedDate, axisLabelXPos+7, axisLabelYPos + 18, 'callout', 0, 0, false, true, "axis-label")
	          .css({
	            color: '#fcfdfd',
	            fontSize: '12px',
	            fontFamily: 'Source Sans Pro',
	            fontWeight: 600
	          })
	          .attr({
	            zIndex: 100
	          })
	          .add();
	        }

	        this.chart.customIconRect = this.chart.renderer.image('images/axis-label-background.png', axisLabelXPos, axisLabelYPos + 4, 54, 20)
	        .attr({
	          zIndex: 99
	        })
	        .add();


	        // Mirror the tooltip on twin charts
	        if(H.charts.length > 1) {
	        
	        	var chartIndexToHover = (arguments[1][0].series.chart.index == 0) ? 1 : 0;
	        	
	        	if(chartIndexToHover < 2) { // using twin chart to want to mirror the tooltip
	        		
	        		// find line index of currently selected line
		        	var seriesIndexToHover = 0;
		        	$.each(H.charts[chartIndexToHover].series, function(key, series){
		        		if(series.selected) {
		        			seriesIndexToHover = key;
		        		}
		        	});

		        	// set the hover on the other graph
		        	var pointIndex = arguments[1][0].index;
		        	if(!hasBeenSet) {
		        		hasBeenSet = true;
		        		// not sure why this if statement is here but there must have been an associated bug
		        		// could try removing to see if there is any lasting effect
		        		if(lastPoint) {
		        			if(H.charts[chartIndexToHover].series[seriesIndexToHover].data[lastPoint] != undefined) { // check if data series are present on the chart
		        				H.charts[chartIndexToHover].series[seriesIndexToHover].data[lastPoint].setState();
	            			H.charts[chartIndexToHover].tooltip.hide();
		        			}		        			
		        		}
		        		lastPoint = pointIndex;
								var arrayOfPointsToHover = [];
								for(var s = 0; s < H.charts[chartIndexToHover].series.length; s++) {
									if(Highcharts.charts[chartIndexToHover].series[s].visible) {
										arrayOfPointsToHover.push(H.charts[chartIndexToHover].series[s].points[pointIndex]);
									}								
								}
		        		H.charts[chartIndexToHover].tooltip.refresh(arrayOfPointsToHover);
			        		
			        	setTimeout(function(){
			        		hasBeenSet = false;
			        	}, 10);
			        }
	        	}
	        }

	        // Add Event Labels
	        	// destroy any existing labels
	        var thisPlotX = arguments[1][0].plotX,
	        		eventTooltip;

	        		if(this.chart.eventTooltips) {
	        			for (var t = 0; t < this.chart.eventTooltips.length; t++) {
	        				this.chart.eventTooltips[t].destroy();
	        			}
	        		}
	        		this.chart.eventTooltips = [];

	        	// remove existing animating CSS class for icons
	        $(".event-icon--launch.is-animating").each(function() {
	        	$(this).attr("class", "event-icon--launch");
	        });
	        $(".event-icon--flag.is-animating").each(function() {
	        	$(this).attr("class", "event-icon--flag");
	        });
	        
        	// create tooltip on event hover
        	var eventsCounter = 0,
	        			previousEventPlotX;
	        			window.animatingFlags = false;

	        if(this.chart.refEvents) {
			      for (var e = 0; e < this.chart.refEvents.length; e++) {
			      	if(this.chart.refEvents[e].plotX == thisPlotX) {
			      		// check if previous event plotX is the same as this plotX, to calculate event details label spacing
			      		if(previousEventPlotX) {
			      			if(previousEventPlotX == this.chart.refEvents[e].plotX) {
			      				eventsCounter++;
			      			} else {
			      				eventsCounter = 0;
			      			}
			      		}
			      		
			      		previousEventPlotX = this.chart.refEvents[e].plotX;
			      		var eventLabelOffset = 80;
			      		if(parseInt(previousEventPlotX) < 100) {
			      			eventLabelOffset = 30;
			      		}
			      		var labelTopSpace = axisLabelYPos + 29 + (eventsCounter * 57);
			      		var eventIcon = this.chart.refEvents[e].icon.element;
			        	eventTooltip = this.chart.renderer.label($(eventIcon).data("tooltip"), this.chart.series[0].data[$(eventIcon).data("datapoint")].plotX - eventLabelOffset, labelTopSpace, 'callout')
			            .css({
			                color: $(eventIcon).data("tooltipcolour")
			            })
			            .attr({
			            		width: 139,
			                fill: $(eventIcon).data("tooltipfill"),
			                padding: 10,
			                r: 5,
			                zIndex: 6
			            })
			            .addClass("chart-event-label")
			            .add();

			         	this.chart.eventTooltips.push(eventTooltip);

			         	// add event icon animate CSS class
			         	var currentCSSClass = $(this.chart.refEvents[e].icon.element).attr("class");
		      			$(this.chart.refEvents[e].icon.element).attr("class", "is-animating " + currentCSSClass);
		      			if(currentCSSClass.indexOf("event-icon--flag") > -1) {
		      				this.chart.refEvents[e].flag = null;
			      			window.animatingFlags = true;
			      			animateSquash = function(flagToAnimate) {
		      					flagToAnimate.animate({width: 15}, 100, function(){
		      						flagToAnimate.animate({width: 18}, 100, function() {
		      							if(window.animatingFlags) {
		      								animateSquash(flagToAnimate);
		      							}      							
		      						});
		      					});
			      			}
			      			animateSquash(Snap(this.chart.refEvents[e].icon.element)); // makes the flag "flap" (uses snap.js)
		      			}
			        }
			      }
			    }
	      });

				H.wrap(H.Series.prototype, 'hide', function (proceed) {

				  // Before the hide function
				  var t = $(this),
				  				par;

				  if(t[0].type == "area") {
				  	if(this.graph != undefined) {
				  		par = $(this.graph.element).parents('.highcharts-series').attr("class", "highcharts-series is-transparent-fade");
				  	}				  	
				  }

				  var instance = this;
				
				  setTimeout(function() {
				  	proceed.apply(instance, Array.prototype.slice.call(arguments, 1));
				  	if(t[0].type == "area" && par != undefined) {
				  		par.attr("class", "highcharts-series");
				  	}
				  }, 200);
				});

				H.Chart.prototype.animateSelectedLines = function(containerId, indexToSelect, previousSelectedIndex) {
	    		$(containerId + ' .highcharts-series').each(function(){
	          var $this = $(this);
	          if($this.attr("data-index") == indexToSelect) {
	            $this.find("path.highcharts-graph").css("opacity", "0.7");
	            $this.find("path.highcharts-graph").animate({ "opacity": 1 }, 250);
	            $this.find("path.highcharts-area").css("opacity", "0");
	            $this.find("path.highcharts-area").animate({ "opacity": 1 }, 250);

	          } else if($this.attr("data-index") == previousSelectedIndex) {
	          	$this.find("path.highcharts-graph").css("opacity", 1);
	            $this.find("path.highcharts-graph").animate({ "opacity": 0.7 }, 250);
	            $this.find("path.highcharts-area").css("opacity", 1);
	            $this.find("path.highcharts-area").animate({ "opacity": 0 }, 250);
	          }
	        });
	    	}

	    	H.Chart.prototype.setSeriesToSelected = function(chartIndex, seriesIndex) {
	    		H.charts[chartIndex].series[seriesIndex].selected = true;
	    		if(H.charts[chartIndex].series[seriesIndex].graph) {
	    			H.charts[chartIndex].series[seriesIndex].graph.element.setAttribute("data-selected", "selected");
	    		}	      	
	    	}

	    	H.Chart.prototype.setSeriesToUnselected = function(chartIndex, seriesIndex) {
	    		$('.chart[data-highcharts-chart="' + chartIndex + '"] .highcharts-series path[data-selected]').removeAttr("data-selected");
	      	H.charts[chartIndex].series[seriesIndex].selected = false;
	    	}

	    	H.Chart.prototype.setGraphCSSClasses = function() {
	   			$.each(H.charts, function(key, chart) {
						$.each(chart.series, function (key, series) {
							series.refseriesindex = key;
							if(series.graph) {
								series.graph.element.setAttribute("data-series-class", key);
					    	series.graph.element.setAttribute("data-index", key);
					    	series.graph.parentGroup.element.setAttribute("data-index", key);
							}
						});

						// set CSS classes on the area fills
						$('.chart[data-highcharts-chart="' + key + '"] .highcharts-series path:nth-child(2)').each(function(){
		          var lineIndex = $(this).attr("data-index");
		          // $(this).parent('.highcharts-series').find('.highcharts-area').attr("class", "series-fill-" + lineIndex);
		        });
					});
	   		}

	   		H.Chart.prototype.resetLineStyling = function() {
					$.each(H.charts, function(key, chart) {
						$.each(chart.series, function (key, series) {
							if(series.graph != undefined) {
								if(series.selected) {
		        			$(series.graph.parentGroup.element).find('.highcharts-graph').css("opacity", "1");
									$(series.graph.parentGroup.element).find('.highcharts-area').css("opacity", "1");
								} else {
									$(series.graph.parentGroup.element).find('.highcharts-graph').css("opacity", "0.7");
									$(series.graph.parentGroup.element).find('.highcharts-area').css("opacity", "0");
								}						
							}							
						});  	
					});
				}

				H.Chart.prototype.setFirstVisibleSeriesToSelected = function() {
					// set first visible line of each chart to be selected
					$.each(H.charts, function(key, chart) {
						for(var s = 0; s < chart.series.length; s++) {
							if(chart.series[s].visible == true) {
								chart.series[s].graph.element.setAttribute("data-selected", "selected");
	      				chart.series[s].selected = true;
								break;
							}
						}
					});
				}

				H.Chart.prototype.setGraphFillsTransparency = function() {
					$.each(H.charts, function(key, chart) {
						$.each(chart.series, function (key, series) {
							if(series.graph != undefined) {
		        		series.graph.parentGroup.element.children[0].setAttribute("style", "opacity: 0.7");
							}
						});  	
					});
				}

				H.Chart.prototype.highlightAChartSeries = function(chartContainerId, seriesToHighlight) {
				$('#' + chartContainerId + ' path[data-series-class=' + seriesToHighlight).each(function(){
					var $this = $(this);
					$this.css("opacity", 0.7);
          $this.animate({ "opacity": 1 }, 100);
				});
			}

			H.Chart.prototype.unhighlightAChartSeries = function(chartContainerId, seriesToUnhighlight) {
				$('#' + chartContainerId + ' path[data-series-class=' + seriesToUnhighlight).each(function(){
					var $this = $(this);
					$this.css("opacity", "1");
          $this.animate({ "opacity": 0.7 }, 100);
				});
			}

	    }(Highcharts));

	    // generateChart is template only to speed up generating three charts in the template
	    function generateChart(containerId, dataType, seriesData, seriesNames, chartType, isMerged) {

	    	var seriesColour,
	    			seriesArray = [],
	    			yAxesSettings; // Mock only

	    	if(isMerged) {

	      } else { // else single chart, so one yaxis
	      	yAxesSettings = [{
	    			reversed: false,
	          offset: -37,
	          showFirstLabel: false,
	          showLastLabel: true,
	          gridLineWidth: 0,
	          labels: {
	          	align: 'left',
	          	style: {
	          		color: '#81879d',
	          		fontSize: "12px"
	          	}
	          },
	          title: {
	          	text: null
	          }         
	        }];
					
					var hiddenSeries = ["Sports", "Food & Drink", "Book", "Finance", "Business", "News", "Lifestyle", "Medical", "Catalogs", "Reference", "Weather"];
					
					var seriesColours = ["#f5c943", "#beb9db", "#fd7f6e", "#7fb1d5", "#f2bdd8", "#c7b299", "#bd7ebf", "#8bd4c7", "#ffb55a", "#d9d9d9", "#918edf", "#DA667B", "#797A9E", "#80AB82", "#EE7674", "#4B8F8C", "#C5979D", "#C9D6EA", "#7261A3", "#F1A66A", "#A54657", "#769FB6", "#BDE4A7", "#9FBBCC"];
					
					var seriesFills = ["rgba(245,201,67,0)", "rgba(190,185,219,1)", "rgba(253,127,110,1)", "rgba(127,177,213,1)", "rgba(242,189,216,1)", "rgba(199,178,153,1)", "rgba(189,126,191,1)", "rgba(139,212,199,1)", "rgba(255,181,90,1)", "rgba(217,217,217,1)", "rgba(145,142,223,1)", "rgba(218,102,123,1)", "rgba(121,122,158,1)", "rgba(128,171,130,1)", "rgba(238,118,116,1)", "rgba(75,143,140,1)", "rgba(197,151,157,1)", "rgba(201,214,234,1)", "rgba(114,97,163,1)",
					"rgba(241,166,106,1)", "rgba(165,70,87,1)",
					"rgba(118,159,182,1)", "rgba(189,228,167,1)",
					"rgba(159,187,204,1)"];
					
	        // TEMPLATE ONLY: Create mock series
	        for(var a = 0; a < seriesData.length; a++) {
						
						var visibility = true;
						if(hiddenSeries.includes(seriesNames[a])) {
							visibility = false;
						}

	        	seriesArray.push({
		         	yAxis: 0,
		          name: seriesNames[a],
		          id : seriesNames[a],
							color: seriesColours[a],
		          data: seriesData[a],
		          borderRadiusTopLeft: 3,
        			borderRadiusTopRight: 3,
		          lineWidthPlus: 0,
		          visible: visibility,
							fillOpacity: 0.2,
		          fillColor: seriesFills[a],
		          marker: {
		            enabled: false,
		            states: {
		              hover: {
		                enabled: true,
		                lineWidth: 0,
		                lineWidthPlus: 0,
		                radius: 4,
		                radiusPlus: 0,
		              }
		            }
		          },
			        type: 'area',
				    	stacking: (a == 0) ? null : 'normal',
				    	lineWidth: 2
		        });
	        }
	      }

	    	// Generate Demo Chart, using the properties set above
				var chart = new Highcharts.Chart({
					chart: {
	          renderTo: containerId,
						marginLeft: 0,
						marginRight: 0,
						marginBottom: 0,
						marginTop: 0,
						spacing: [0,0,0,0],
						height: 450,
						backgroundColor: '#fcfdfd',
						plotBackgroundColor: '#f2f2f5',
			   		type: chartType,
			   		animation: false,
			   		style: {
	            fontFamily: 'Source Sans Pro'
	          },
	          events: {
	            load: function() {
	                var countIndex = 0;
	                var graphPointAnimationDelay = 20;

	                // set the all series opacity on load
	                var countIndex = 0;
	                $('#' + containerId + ' .highcharts-series path:nth-child(2)').each(function() { // gets each series line
	                  if (countIndex > 0) { // first series is set to visible
	                    $(this).attr("style", "opacity: 1");
	                    $(this).siblings("path").attr("style", "opacity: 0.7");
	                  } else {
	                    $(this).attr("style", "opacity: 1");
	                  }
	                  countIndex++;
	                });
	            }
	          }
				  },
				  legend: {
				  	enabled: true
				  },
				  title: {
	            text: ''
	        },
	        yAxis: yAxesSettings,
	        xAxis: {
	        	lineColor: '#e1e5e8',
            lineWidth: 1,
	        	startOnTick: true,
	        	endOnTick: true,
	        	showFirstLabel: false,
	          maxPadding: 0,
	          minPadding: 0,
	          type: 'datetime',
	          dateTimeLabelFormats: {
	              day: '%e %b'
	          },
	          tickmarkPlacement: 'on',
	          tickLength: 0,
	          labels: {
	          	align: 'center',
	            x: 0,
	            y: 18,
	            step: 2,
	            style: {
	              color: '#81879d',
	              fontSize: "12px"
	            }
	          },
	        },
	        plotOptions: {
	        	area: {
	            trackByArea: false,
	        		tooltip: {
	        			followPointer: false
	        		},
	        		states: {
	        			hover: {
	        				halo: {
	        					size: 0
	        				},
	        				lineWidthPlus: 0
	        			}
	        		},
	        		marker: {
	        			symbol: "circle"
	        		}		
	        	},
	        	bar: {
	        		borderColor: "#f2f2f5",
	        		borderWidth: 1,
	        		groupPadding: 0.08,
	        		pointPadding: 0,
	        		states: {
	        			hover : {
	        				brightness: 0.1
	        			}
	        		}
	        	},
	          series: {
	            animation: false
	          },
	      	},
	        series: seriesArray,
	        tooltip: {
	        	useHTML: true,
	        	shared: true,
	          formatter: function() {	          	
	            var instance = this;
	            var s = "";
	            var thisPointIndex = instance.points[0].point.index;
	            // for stacked percentage
	            // TO DO - bug if first line is off
	            var thisPointTotalValue = instance.points[0].series.chart.series[0].data[thisPointIndex].y;

	            $.each(instance.points, function (index, value) {
	                var chartSeries = value.series;
	                var imgString = "",
	                		storeString = "",
	                		valueString = chartSeries.name.substring(0, 8) + ": ",
	                		stackedString = "";

	                if(chartSeries.name == "revenueseries") {
	                	valueString = "$ ";
	                }
	                if(chartSeries.name == "revenueseries-total") {
	                	valueString = "$ ";
	                }
	                
	                var seriesClassName = chartSeries.name;
	                if(seriesClassName == "revenueseries-total") {
	                	seriesClassName = "revenueseries";
	                } else if(seriesClassName == "downloadsseries-total") {
	                	seriesClassName = "downloadsseries";
	                }

	                if(thisPointTotalValue != undefined) {
	                	var percentageOfTotal = (value.y / thisPointTotalValue * 100).toFixed(1);
	                	stackedString = "<span class='chart-tooltip-percentage' style='background-color: " + chartSeries.color + "'>" + percentageOfTotal + "%</span>";
	                }

	                s += '<div class="custom-tooltip ' + seriesClassName + '" style="background-color: ' + chartSeries.color + '"><span class="chart-tooltip-value">' + valueString + value.y + '</span>' + stackedString + '</div>';
	            });
	            return s;
	          },
	        	backgroundColor: 'transparent',
	          borderWidth: 0,
	          borderColor: '#dae3ed',
				    crosshairs: [{
	            width: 1,
	            color: '#9ea7c4'
	          }],
	          shadow: {
	            color: 'rgba(0,0,0,0.24)',
	            width: 0,
	            offsetX: 1,
	            offsetY: 1
	        	},
	        	snap: 25,
	        	// the positioner callback could be used in future for the combined chart where it goes off the left of the graph
	        	positioner: function (labelWidth, labelHeight, point) {
              var chartWidth = $('.highcharts-container').width();
              var xPlot = point.plotX;
              if(point.plotX > chartWidth / 2) {
								xPlot -= 200;
              }
              return { x: xPlot, y: 0 };
            },
	        }
		    });

			} // end generateChart()

			function handleMouseEnterChartKeyLabel($label) {
				if($('html.no-touch').length) {
					var $this = $label.siblings("input");
					var chartToHoverIndex = $this.attr("data-chart-index");
					var seriesToHover = $this.attr("data-series-index");

					var seriesToHoverArray = [seriesToHover];

					if(chartToHoverIndex < 2) { // if it's the twin chart

						for (var ch = 0; ch < 2; ch++) { // for each of the twin charts

							var chartContainerId = Highcharts.charts[ch].container.id;

							var selectedLine = $('#' + chartContainerId + ' .highcharts-series path[data-selected]').attr("data-index");

							for(var i = 0; i < seriesToHoverArray.length; i++) { // highlight one or more lines on same chart

								if(selectedLine != undefined) { // if there is a selected line, it's the area chart, just highlight the line
									if(!Highcharts.charts[ch].series[seriesToHoverArray[i]].selected) {
										Highcharts.Chart.prototype.highlightAChartSeries(chartContainerId, seriesToHoverArray[i]);
									}

								} else { // otherwise it's the stacked chart, just highlight the fill

									$('#' + chartContainerId + ' .series-fill-' + seriesToHoverArray[i]).each(function(){
										var $this = $(this);
										$this.css("opacity", 0.25);
				            $this.animate({ "opacity": 0.6 }, 100);
									});
								}
							}
						}
					} else { // user is hovering over combined chart key label
						// get the corresponding line to hover
						if(seriesToHover != 0 && seriesToHover != 1) {
							seriesToHoverArray.push(seriesToHover - 1);
						}
						var chartContainerId = Highcharts.charts[chartToHoverIndex].container.id;

						for(var i = 0; i < seriesToHoverArray.length; i++) {
							if(!Highcharts.charts[2].series[seriesToHoverArray[i]].selected) {
								Highcharts.Chart.prototype.highlightAChartSeries(chartContainerId, seriesToHoverArray[i]);
							}
						}
					}
				}
			}

			function handleMouseLeaveChartKeyLabel($label) {
				if($('html.no-touch').length) {
					var $this = $label.siblings("input");
					var chartToHoverIndex = $this.attr("data-chart-index");
					var seriesToHover = $this.attr("data-series-index");
					var seriesToHoverArray = [seriesToHover];

					if(chartToHoverIndex < 2) { // if it's the twin chart
						for (var ch = 0; ch < 2; ch++) { // for each of the twin charts

							var chartContainerId = Highcharts.charts[ch].container.id;
							var selectedLine = $('#' + chartContainerId + ' .highcharts-series path[data-selected]').attr("data-index");

							for(var i = 0; i < seriesToHoverArray.length; i++) { // highlight one or more lines on same chart
								if(selectedLine != undefined) { // if there is a selected line, it's the area chart, just highlight the line
									if(!Highcharts.charts[ch].series[seriesToHoverArray[i]].selected) {
										Highcharts.Chart.prototype.unhighlightAChartSeries(chartContainerId, seriesToHoverArray[i]);
									}
								} else { // otherwise it's the stacked chart, just highlight the fill

									$('#' + chartContainerId + ' .series-fill-' + seriesToHoverArray[i]).each(function(){
										var $this = $(this);
										$this.css("opacity", 0.6);
				            $this.animate({ "opacity": 0.25 }, 100);
									});
								}
							}
						}
					} else { // it's the combined chart
						
						// get the corresponding line to hover
						if(seriesToHover != 0 && seriesToHover != 1) {
							seriesToHoverArray.push(seriesToHover - 1);
						}
						var chartContainerId = Highcharts.charts[chartToHoverIndex].container.id;

							for(var i = 0; i < seriesToHoverArray.length; i++) {
								if(!Highcharts.charts[2].series[seriesToHoverArray[i]].selected) {
									Highcharts.Chart.prototype.unhighlightAChartSeries(chartContainerId, seriesToHoverArray[i]);
								}
							}
					}
				}
			}

			function addASeriesToggle(seriesIndex, seriesName, availableColourIndex) {

				// Add a new toggle to the chart key
				var newToggle = $('<li>').addClass("series-" + availableColourIndex);
				var newCheckbox = $('<input>').attr("type", "checkbox")
																			.attr("name", seriesName)
																			.attr("id", seriesName)
																			.addClass("js-toggle-series")
																			.attr("data-chart-index", "0")
																			.attr("data-series-index", seriesIndex)
																			.attr("checked", "checked");
				
				var newCheckboxLabel = $('<label>').attr("for", seriesName)
																						.addClass("checkboxLabel")
																						.text("Another App");

				var newCheckboxLabelVisible = $('<label>').attr("for", seriesName)
																						.addClass("checkboxLabelVisible")
																						.attr("data-chart-index", "0")
																						.text("Another App")
																						.on("mouseenter", function(){
																							handleMouseEnterChartKeyLabel($(this));
																						})
																						.on("mouseleave", function(){
																							handleMouseLeaveChartKeyLabel($(this));
																						});

				newToggle.append(newCheckbox)
									.append(newCheckboxLabel)
									.append(newCheckboxLabelVisible);

				$('.js-twin-chart-container .js-custom-chart-key ul').append(newToggle);

				// Add a new toggle to the chart key on the combined chart
				// combined revenue checkbox
				seriesName += "-combined";
				var newToggle = $('<li>').addClass("revenue-key-combined-chart series-" + availableColourIndex);
				var newCheckbox = $('<input>').attr("type", "checkbox")
																			.attr("name", seriesName)
																			.attr("id", seriesName)
																			.addClass("js-toggle-series")
																			.attr("data-chart-index", "2")
																			.attr("data-series-index", seriesIndex * 2)
																			.attr("checked", "checked");
				
				var newCheckboxLabel = $('<label>').attr("for", seriesName)
																						.addClass("checkboxLabel")
																						.text("Another App");

				var newCheckboxLabelVisible = $('<label>').attr("for", seriesName)
																						.addClass("checkboxLabelVisible js-hover-series");

				newToggle.append(newCheckbox)
									.append(newCheckboxLabel)
									.append(newCheckboxLabelVisible);

				// combined downloads checkbox
				seriesName += "--downloads";
				var newToggleDownloads = $('<li>').addClass("downloads-key-combined-chart series-" + availableColourIndex);
				var newCheckbox = $('<input>').attr("type", "checkbox")
																			.attr("name", seriesName)
																			.attr("id", seriesName)
																			.addClass("js-toggle-series")
																			.attr("data-chart-index", "2")
																			.attr("data-series-index", (seriesIndex * 2) + 1)
																			.attr("checked", "checked");
				
				var newCheckboxLabel = $('<label>').attr("for", seriesName)
																						.addClass("checkboxLabel")
																						.text("Another App");

				var seriesIndexPlusOne = (seriesIndex * 2) + 1;
				var newCheckboxLabelVisible = $('<label>').attr("for", seriesName)
																						.addClass("checkboxLabelVisible js-hover-series")
																						.text("Another App")
																						.on("mouseenter", function(){
																							handleMouseEnterChartKeyLabel($(this));
																						})
																						.on("mouseleave", function(){
																							handleMouseLeaveChartKeyLabel($(this));
																						});

				newToggleDownloads.append(newCheckbox)
									.append(newCheckboxLabel)
									.append(newCheckboxLabelVisible);

				$('.js-combined-chart-container .js-custom-chart-key ul').append(newToggle);
				$('.js-combined-chart-container .js-custom-chart-key ul').append(newToggleDownloads);
			}

			// Generate Demo Charts
			var mockDataRevenue = [[]],
					seriesNames = ["Total"];
			
			var usedSeriesColours = [];

			setTimeout(function() {

				for(var s = 0; s < chartData.length; s++) {
					seriesNames.push(chartData[s].name);
					var mockSeries = [];				
					for(var d = 0; d < chartData[s].data.length; d++) {
						if(chartData[s].data[d]) {
							var dataDate = new Date(chartData[s].data[d].date * 1000);
							var dataDay = dataDate.getDate() + 1;
							var dataMonth = dataDate.getMonth();
							var dataYear = dataDate.getFullYear();
							mockSeries.push([Date.UTC(dataYear, dataMonth, dataDay), chartData[s].data[d].value]);
						}
					}
					mockDataRevenue.push(mockSeries);
				}				
				
				// TODO AWAITING ORDERED DATA FROM NIC
				var mockSeriesTotal = []; // MOCK TOTAL COMES BY ADDING UP REST OF THE DATA - TEMPLATE ONLY
				console.log(mockDataRevenue.length);
				for(var d = 0; d < 14; d++) {
					var totalOfSeriesForDataPoint = 0;
					for(var s = 0; s < mockDataRevenue.length; s++) {
						
						if(mockDataRevenue[s][d] && mockDataRevenue[s][d][1]) {
							totalOfSeriesForDataPoint = totalOfSeriesForDataPoint + parseInt(mockDataRevenue[s][d][1]);
						}
					}

					mockSeriesTotal.push([mockDataRevenue[1][d][0], totalOfSeriesForDataPoint]);					
				}

 				mockDataRevenue[0] = mockSeriesTotal;

				console.log(mockSeriesTotal);

				generateChart('chart-revenue', "revenueseries", mockDataRevenue, seriesNames, "area", false);

				$('.chart-container').addClass('is-animated');

				Highcharts.Chart.prototype.setGraphCSSClasses();
			}, 500);
			
			setTimeout(function(){
				$('.js-alert-urgent').addClass("is-open");
			}, 1000);

			mockAppPicker();
  	}

  	function mockAppPicker() {
			$('.js-group-trigger').on("click", function(){ // to open the country selector
				var $this = $(this),
						thisPositionTop = $this.offset().top,
						thisPositionLeft = $this.offset().left,
						thisHeight = $this.innerHeight(),
						thisWidth = $this.innerWidth(),
						offsetTop = 10,
						isAlreadyOpen = $this.parent('.js-form-field--group').hasClass("is-open"),
						groupPickerWidth = 650;
				
				if(!isAlreadyOpen) {
					setTimeout(function(){ // setTimeout is to wait for all other popups to close first
						
						$('.js-group-selector-overlay').show();
						$('.js-app-selector').show().css({ "top" : thisPositionTop + thisHeight + offsetTop, "left" : thisPositionLeft});
						$this.parent(".js-form-field--group").addClass("is-open");
						
					}, 100);
				} else {
					$('.js-group-selector-overlay').hide();
					$('.js-app-selector').hide();
					$this.parent(".js-form-field--group").removeClass("is-open");
				}
			});
  	}

  	window.onready = initScripts();
  </script>
		
	<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5513f37846b6ec2e"></script>
</body>